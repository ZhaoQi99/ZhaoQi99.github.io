<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="googleacbf0c232246c14c">
  <meta name="msvalidate.01" content="459FB2FD55046A1DECE2CCD9DDB4CDC6">
  <meta name="baidu-site-verification" content="hxB6RGtiSLTYdVdv">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-corner-indicator.min.css">
  <script src="/lib/pace/pace.min.js"></script>


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://zhaoqi.vip').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.1',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="keywords" content="赵旗,Qi Zhao,SNNU,ZhaopQi99,Python,陕西师范大学">
<meta property="og:type" content="website">
<meta property="og:title" content="温柔小猪">
<meta property="og:url" content="https://zhaoqi.vip/index.html">
<meta property="og:site_name" content="温柔小猪">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="温柔小猪">

<link rel="canonical" href="https://zhaoqi.vip/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>温柔小猪</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117346785-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-117346785-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">温柔小猪</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">26</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/2620614917.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2620614917.html" class="post-title-link" itemprop="url">在Django中间件处对API进行统一处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-04 17:56:00" itemprop="dateCreated datePublished" datetime="2019-10-04T17:56:00+08:00">2019-10-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Django/" itemprop="url" rel="index">
                    <span itemprop="name">Django</span>
                  </a>
                </span>
            </span>

          
            <span id="/2620614917.html" class="post-meta-item leancloud_visitors" data-flag-title="在Django中间件处对API进行统一处理" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>公司实习时遇到一个问题:项目中所使用不是Restful API,每个视图函数都要先生成字典，于是项目中便充斥着如下的代码:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result=&#123;</span><br><span class="line">	<span class="string">"msg"</span>:<span class="string">'xx",</span></span><br><span class="line"><span class="string">	"status":200,</span></span><br><span class="line"><span class="string">	"result":data</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">return HttpResponse(json.loads(result))</span></span><br></pre></td></tr></table></figure></p>
<p>维护起来比较麻烦，对前端也很不友好，为了解决该问题，自定义了一个Django中间件对API格式和异常进行统一处理，以此达到如下效果:</p>
<ul>
<li>在view中只需返回<code>data</code>，<code>raise</code>自定义的异常</li>
<li>实现自定义异常状态码(<code>status</code>)和自定义异常信息(<code>message</code>)</li>
<li>view中返回的<code>Object</code>若为<code>Model</code>,则会返回调用其<code>__str__</code>方法的结果</li>
<li>对于<code>view</code>中出现的其他异常，<code>Response</code>会返回<code>Unknown exception</code></li>
<li>异常信息(<code>message</code>)实现了<code>i18n</code></li>
</ul>
<h1 id="Django中对异常的处理"><a href="#Django中对异常的处理" class="headerlink" title="Django中对异常的处理"></a>Django中对异常的处理</h1><h2 id="Django中对request的处理"><a href="#Django中对request的处理" class="headerlink" title="Django中对request的处理"></a>Django中对request的处理</h2><ul>
<li>首先执行<code>process_request</code>函数，然后在执行视图函数之前执行<code>process_view</code>函数，再执行视图函数，最后执行<code>process_response</code>函数</li>
<li><code>process_request</code>只返回<code>None</code>，所有中间件的<code>process_request</code>执行完之后，就匹配路由，找到对应的视图函数，在执行视图函数之前先执行中间件的 <code>process_view</code>函数</li>
<li>如果<code>process_view</code>返回 None，就继续执行后续的中间件的<code>process_view</code>方法，执行完所有的<code>process_view</code>函数之后执行视图函数</li>
<li>如果其中有个 process_view 返回了 HttpResponse，就不执行后续的 process_view 函数，会跳到第一个 process_response 函数，并继续往下执行</li>
</ul>
<p><img src="../images/pasted-0.png" alt="Diango中中间件处理过程"></p>
<h2 id="中间件-类-中5种方法"><a href="#中间件-类-中5种方法" class="headerlink" title="中间件(类)中5种方法"></a>中间件(类)中5种方法</h2><p>中间件中可以定义5个方法:</p>
<ul>
<li>process_request(request)</li>
<li>process_view(request, view_func, view_args, view_kwargs)</li>
<li>process_exception(request, exception)</li>
<li>process_template_response(request, response)</li>
<li>process_response(request, response)</li>
</ul>
<h3 id="process-request"><a href="#process-request" class="headerlink" title="process_request"></a>process_request</h3><ol>
<li>中间件在收到<code>request</code>请求之后执行</li>
<li>按照<code>settings.py</code>中<code>MIDDLEWARE_CLASSES</code>的顺序，顺序执行</li>
<li>如果该函数返回<code>None</code>，继续执行后面的中间件的<code>process_request</code>方法</li>
<li>如果该函数返回<code>HttpResponse</code>，则不再继续执行后面的中间件的<code>process_request</code>方法</li>
</ol>
<h3 id="process-view"><a href="#process-view" class="headerlink" title="process_view"></a>process_view</h3><ol>
<li>执行完所有中间件的<code>process_request</code>方法</li>
<li>在<code>urls.py</code>中找到对应视图函数</li>
<li>拿到视图函数的名称、参数，在执行视图函数之前执行</li>
<li>如果返回<code>None</code>，则继续执行后面的中间件的<code>process_view</code>函数，然后执行下昂应的视图函数</li>
<li>如果返回<code>HttpResponse</code>，则不执行后续的<code>process_view</code>函数，也不执行视图函数，然后执行所有的<code>response</code>中间件</li>
</ol>
<h3 id="process-exception"><a href="#process-exception" class="headerlink" title="process_exception"></a>process_exception</h3><ol>
<li>执行视图函数的过程中如果引发异常，则按照<code>settings.py</code>中<code>MIDDLEWARE_CLASSES</code>的顺序，倒序执行<code>process_exception</code>方法</li>
<li>如果返回<code>None</code>，继续执行下一个中间件的<code>process_exception</code>方法 </li>
<li>如果返回<code>HttpReponse</code>对象，则该中间件上方其他中间件的<code>process_exception</code>方法不会被调用</li>
<li>一旦其中某个中间件有返回值，则调用<code>template_response</code>和<code>response</code>中间件<br>,否则启动<a href="https://docs.djangoproject.com/zh-hans/2.1/ref/views/#error-views" target="_blank" rel="noopener">默认的异常处理</a></li>
</ol>
<div class="note info">
            <p>最后半句个人理解:如果如果所有中间件的<code>process_exception</code>方法都执完后还没有返回值，则启动默认的异常处理</p>
          </div>
<h3 id="process-template-response"><a href="#process-template-response" class="headerlink" title="process_template_response"></a>process_template_response</h3><ol>
<li>在视图函数执行结束之后执行</li>
<li><code>response</code>是Django视图或者某一中间件的返回值(<code>TemplateResponse</code>对象或等价)</li>
<li>只有<code>response</code>实现了<code>render</code>方法才会执行</li>
<li>一旦所有的中间件的<code>template_response</code>被执行完，则调用<code>render</code>方法</li>
<li>按照中间件的顺序，倒序执行</li>
</ol>
<h3 id="process-response"><a href="#process-response" class="headerlink" title="process_response"></a>process_response</h3><ol>
<li>在视图函数执行结束之后执行</li>
<li>必须有返回值，且返回类型必须是<code>HttpResponse</code>对象</li>
<li>按照中间件的顺序，倒序执行</li>
</ol>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><ul>
<li>middleware.py<div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.models <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.core.serializers.json <span class="keyword">import</span> DjangoJSONEncoder</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isinstance(exception, BaseException):</span><br><span class="line">            <span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(&#123;<span class="string">‘result’</span>: <span class="string">‘’</span>, <span class="string">‘msg’</span>: str(exception), <span class="string">‘status’</span>: <span class="number">1000</span>&#125;)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> JsonResponse(UnknownException().as_dict())</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(exception.as_dict())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></span><br><span class="line">        procese_type = (list, tuple, dict, str, int)</span><br><span class="line">        <span class="keyword">if</span> isinstance(response, models.Model):</span><br><span class="line">            response = str(response)</span><br><span class="line">        <span class="keyword">if</span> isinstance(response, procese_type):</span><br><span class="line">            ret = &#123;<span class="string">‘result’</span>: response, <span class="string">‘msg’</span>: <span class="string">‘success’</span>, <span class="string">‘status’</span>: <span class="number">200</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> JsonResponse(ret, encoder=DjangoJSONEncoder)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure></div></div></li>
<li>exceptions.py<div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABCMeta</span><br><span class="line"><span class="keyword">from</span> .message <span class="keyword">import</span> ErrorMsg</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterFaceAsDictInterFace</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_dict</span><span class="params">(self)</span>:</span></span><br><span class="line">        ret = &#123;<span class="string">‘result’</span>: <span class="string">‘’</span>, <span class="string">‘msg’</span>: getattr(self, <span class="string">‘<strong>msg</strong>‘</span>, <span class="string">‘’</span>), <span class="string">‘status’</span>: getattr(self, <span class="string">‘<strong>status</strong>‘</span>, <span class="string">‘’</span>)&#125;</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseException</span><span class="params">(Exception, InterFaceAsDictInterFace)</span>:</span></span><br><span class="line">    <strong>metaclass</strong> = ABCMeta</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title"><strong>init</strong></span><span class="params">(self, msg=None)</span>:</span></span><br><span class="line">        super(BaseException, self).<strong>init</strong>()</span><br><span class="line">        <span class="keyword">if</span> msg <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.<strong>msg</strong> = msg</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnknownException</span><span class="params">(InterFaceAsDictInterFace)</span>:</span></span><br><span class="line">    <strong>status</strong> = <span class="number">1000</span></span><br><span class="line">    <strong>msg</strong> = ErrorMsg.UNKNOWN_EXCEPTION</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyException</span><span class="params">(BaseException)</span>:</span></span><br><span class="line">    <strong>status</strong>=<span class="number">1001</span></span><br><span class="line">    <strong>msg</strong>=ErrorMsg.MY_EXCEPTION</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></li>
<li>message.py<div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext <span class="keyword">as</span> _</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span>:</span></span><br><span class="line">    UNKNOWN_EXCEPTION= _(<span class="string">‘Unknown exception.’</span>)</span><br><span class="line">    MY_EXCEPTION = _(<span class="string">‘Test exception.’</span>)</span><br></pre></td></tr></table></figure></div></div>
</li>
</ul>
<h2 id="修改settings文件"><a href="#修改settings文件" class="headerlink" title="修改settings文件"></a>修改settings文件</h2><p>修改<code>setting</code>中的<code>MIDDLEWARE_CLASSES</code>变量<br><div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">‘django.middleware.security.SecurityMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.contrib.sessions.middleware.SessionMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.middleware.common.CommonMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.middleware.csrf.CsrfViewMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.contrib.auth.middleware.AuthenticationMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.contrib.messages.middleware.MessageMiddleware’</span>,</span><br><span class="line">    <span class="string">‘django.middleware.clickjacking.XFrameOptionsMiddleware’</span>,</span><br><span class="line">    <span class="string">‘middleware.MyMiddleware’</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure></div></div></p>
<h1 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h1><h2 id="对前端Post请求进行参数校验"><a href="#对前端Post请求进行参数校验" class="headerlink" title="对前端Post请求进行参数校验"></a>对前端Post请求进行参数校验</h2><p>目前想出来了两种策略(假设<code>post_json</code>为序列化后的字典):</p>
<ol>
<li>视图函数中使用<code>get</code>从字典中获取参数，判断<code>required</code>的参数是否为空，<code>raise</code>自定义的异常，如:<div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exception.py</span></span><br><span class="line">…</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidationError</span><span class="params">(BaseException)</span>:</span></span><br><span class="line">    <strong>msg</strong> = ErrorMsg.INVALID_ARGUMENT</span><br><span class="line">    <strong>status</strong> = <span class="number">1001</span></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># message.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span>:</span></span><br><span class="line">    UNKNOWN_EXCEPTION= _(<span class="string">‘Unknown exception.’</span>)</span><br><span class="line">    INVALID_ARGUMENT = _(<span class="string">‘Invalid arguments.’</span>)</span><br><span class="line">    REQUIRED_ARGUMENT = _(<span class="string">‘A &#123;0&#125; argument is required.’</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    …</span><br><span class="line">    user_name = post_json.get(<span class="string">‘username’</span>,<span class="string">‘’</span>)<span class="comment"># required</span></span><br><span class="line">    pass_word = post_json.get(<span class="string">‘password’</span>,<span class="string">‘’</span>)<span class="comment"># required</span></span><br><span class="line">    user_type = post_json.get(<span class="string">‘user_type’</span>,<span class="string">‘’</span>)<span class="comment"># not required</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">        <span class="keyword">raise</span> ValidationError(ErrorMsg.REQUIRED_ARGUMENT.format(<span class="string">‘username/passswordd’</span>))</span><br><span class="line">    …</span><br></pre></td></tr></table></figure></div></div></li>
<li>视图函数中对参数不做校验，只需在中间件添加一句，即可对视图函数中<code>raise</code>的<code>KeyError</code>进行统一处理<div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exception.py</span></span><br><span class="line">…</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidationError</span><span class="params">(BaseException)</span>:</span></span><br><span class="line">    <strong>msg</strong> = ErrorMsg.INVALID_ARGUMENT</span><br><span class="line">    <strong>status</strong> = <span class="number">1001</span></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="comment"># middleware.py</span></span><br><span class="line">…</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line"> <span class="keyword">if</span> isinstance(exception, KeyError):</span><br><span class="line">    exception = ValidationError(ErrorMsg.REQUIRED_ARGUMENT.format(exception))</span><br><span class="line">    …</span><br><span class="line"></span><br><span class="line"><span class="comment"># message.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErrorMsg</span>:</span></span><br><span class="line">    UNKNOWN_EXCEPTION= _(<span class="string">‘Unknown exception.’</span>)</span><br><span class="line">    INVALID_ARGUMENT = _(<span class="string">‘Invalid arguments.’</span>)</span><br><span class="line">    REQUIRED_ARGUMENT = _(<span class="string">‘A &#123;0&#125; argument is required.’</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># view.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    …</span><br><span class="line">    user_name = post_json[<span class="string">‘user_name’</span>] <span class="comment"># required</span></span><br><span class="line">    user_type = post_json.get(<span class="string">‘user_type’</span>,<span class="string">‘’</span>)<span class="comment"># not required</span></span><br><span class="line">    …</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div>
</li>
</ol>
<h2 id="视图函数返回"><a href="#视图函数返回" class="headerlink" title="视图函数返回"></a>视图函数返回</h2><p>目前视图函数必须有返回值，不能为<code>None</code>，还不知道怎么解决</p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><ul>
<li><a href="https://docs.djangoproject.com/zh-hans/2.1/topics/http/middleware/" target="_blank" rel="noopener">Django 中间件官方文档</a></li>
<li><a href="https://docs.djangoproject.com/zh-hans/2.2/topics/i18n/translation/" target="_blank" rel="noopener">Django 国际化官方文档</a></li>
<li><a href="https://github.com/shaowenchen/django-exceptionbox" target="_blank" rel="noopener">Github项目(django-exceptionbox)</a></li>
<li><a href="https://www.chenshaowen.com/blog/error-code-design-and-unified-processing-in-django.html#32-ExceptionBox" target="_blank" rel="noopener">错误码设计以及 Django 的异常统一处理</a></li>
<li><a href="https://www.cnblogs.com/huchong/p/7819296.html" target="_blank" rel="noopener">Django—-中间件详解</a></li>
</ul>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/2604890615.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2604890615.html" class="post-title-link" itemprop="url">人生苦短，我用Python</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-19 22:01:00" itemprop="dateCreated datePublished" datetime="2019-03-19T22:01:00+08:00">2019-03-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          
            <span id="/2604890615.html" class="post-meta-item leancloud_visitors" data-flag-title="人生苦短，我用Python" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前几日代写留学生作业时遇到了两道很有意思的Python编程题，在此做一记录，主要涉及到一些Python的高级特性:生成器、lambda表达式。</p>
<h1 id="Question-1"><a href="#Question-1" class="headerlink" title="Question 1"></a>Question 1</h1><h2 id="题意"><a href="#题意" class="headerlink" title="题意"></a>题意</h2><p><strong>原文:</strong><br>Consider the following function<br><div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># listOfNumbers is a list of only numbers</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">processList</span><span class="params">(listOfNumbers)</span>:</span></span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> listOfNumbers:</span><br><span class="line">        <span class="keyword">if</span> i&lt;<span class="number">0</span> == <span class="number">0</span>:</span><br><span class="line">            result.append(i<em>i)</em></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append((ii)+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure></div></div></p>
<p>First, study and test processList(listOfNumbers) to determine what it does Then rewrite its body so that it accomplishes the same task with a one-line list comprehension. Thus, the resulting function will have exactly two lines, the def line and a return line containing a list comprehension expression.<br><strong>翻译:</strong><br>将给出的一个函数变成两行</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>函数的功能是:遍历listofNumbers中的每一个元素，如果大于等于0，将其变成自己乘以自己，否则变为自己乘自己后再加一。<br>因此，我们可以用到Python中的三元表达式，下面这两种方式是等价的。<br><code>value = true if condition else false</code><br>与<br><div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> condition:</span><br><span class="line">    value = true</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    value = false</span><br></pre></td></tr></table></figure></div></div></p>
<h2 id="参考答案"><a href="#参考答案" class="headerlink" title="参考答案"></a>参考答案</h2><div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">processList</span><span class="params">(listOfNumbers)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> [i <em> i <span class="keyword">if</span> i &gt;= <span class="number">0</span> <span class="keyword">else</span> i </em> i + <span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> listOfNumbers]</span><br></pre></td></tr></table></figure></div></div>
<h1 id="Question-2"><a href="#Question-2" class="headerlink" title="Question 2"></a>Question 2</h1><h2 id="题意-1"><a href="#题意-1" class="headerlink" title="题意"></a>题意</h2><p><strong>原文:</strong><br>Implement function processList2(inputList, specialItem, ignoreItems) that returns a new list that contains all the items of inputList (and in the original order) except 1) any that appear in the list ignoreItems, and 2) occurrences of specialItem (if specialItem is not in ignoreItems) should become the string “special” in the new list. Use a one-line list cluoomprehension to construct the new list. Thus, again, the function will have exactly two lines, the def line and a return line containing a list comprehension expression. For example,<br><div class="note default no-icon">
            <p>processList2([1,2,3,4], 4, [3])<br>[1, 2, ‘special’]<br>processList2([1,2,3,4,True,’dog’], 4, [3,5,4])<br>[1, 2, True, ‘dog’]<br>processList2([1,1,2,2], 1, [2])<br>[‘special’, ‘special’]</p>
          </div><br><strong>翻译:</strong><br>实现函数processList2(inputList, specialItem, ignoreItems)，对inputList中的元素进行处理，返回一个新列表，但需满足以下两个要求:</p>
<ol>
<li>不能是出现在ignoreItems中的元素</li>
<li>对于与specialItem相同的元素(不能在ignoreItems中出现)，将其变成”special”。</li>
</ol>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><ol>
<li>首先将不在ignoreItems中的那些元素筛出来<code>[x for x in inputList if x not in ignoreItems]</code>或<code>list(filter(lambda x:False if x in ignoreItems else True,inputList))</code>。</li>
<li>然后遍历上述列表中的元素，将specialItem变成”special”,<code>[&quot;special&quot; if x == specialItem else x for x in xxx]</code></li>
</ol>
<h2 id="参考答案-1"><a href="#参考答案-1" class="headerlink" title="参考答案"></a>参考答案</h2><div class="spoiler collapsed"><div class="spoiler-title">Code</div><div class="spoiler-content"><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">processList2</span><span class="params">(inputList, specialItem, ignoreItems)</span>:</span></span><br><span class="line">    <span class="comment">## two method</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="string">“special”</span> <span class="keyword">if</span> x == specialItem <span class="keyword">else</span> x <span class="keyword">for</span> x <span class="keyword">in</span> list(filter(<span class="keyword">lambda</span> x:<span class="literal">False</span> <span class="keyword">if</span> x <span class="keyword">in</span> ignoreItems <span class="keyword">else</span> <span class="literal">True</span>,inputList))]</span><br><span class="line">    <span class="keyword">return</span>[<span class="string">“special”</span> <span class="keyword">if</span> x == specialItem <span class="keyword">else</span> x <span class="keyword">for</span> x <span class="keyword">in</span> [x <span class="keyword">for</span> x <span class="keyword">in</span> inputList <span class="keyword">if</span> x <span class="keyword">not</span> <span class="keyword">in</span> ignoreItems]]</span><br></pre></td></tr></table></figure></div></div>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.runoob.com/python3/python3-func-filter.html" target="_blank" rel="noopener">filter() 函数</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431779637539089fd627094a43a8a7c77e6102e3a811000" target="_blank" rel="noopener">列表生成式</a></li>
</ul>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/560540611.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/560540611.html" class="post-title-link" itemprop="url">ThinkServer RD650安装Ubuntu Server 16.04</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-24 22:50:22" itemprop="dateCreated datePublished" datetime="2018-07-24T22:50:22+08:00">2018-07-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          
            <span id="/560540611.html" class="post-meta-item leancloud_visitors" data-flag-title="ThinkServer RD650安装Ubuntu Server 16.04" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>在Ubuntu官网上下载Ubuntu Server 16.04的ISO镜像(<a href="http://releases.ubuntu.com/16.04/" target="_blank" rel="noopener">下载链接</a>)；</li>
<li>使用刻录软件(如:软碟通)将iso镜像文件写入U盘中，制成启动盘；</li>
<li>将ISO镜像文件拷贝至U盘的根目录，为了方便后续操作，这里可将镜像文件重命名为<code>Ubuntu.iso</code>；</li>
</ol>
<h2 id="设置引导"><a href="#设置引导" class="headerlink" title="设置引导"></a>设置引导</h2><ol>
<li>按电源键开机，启动服务器(服务器启动可能会比较缓慢)；<br><img src="/images/Ubuntu Server 16.04/IMG20180724134039.jpg" alt></li>
<li>出现此界面时，按”F10”进入TDM(ThinkServer Deployment Manager)；<br><img src="/images/Ubuntu Server 16.04/IMG20180724134100.jpg" alt></li>
<li>进入TDM后，选择”BIOS Setup(BIOS 设置)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724134421.jpg" alt></li>
<li>选择”Boot Manager(引导管理)”,将”Boot Mode(引导模式)”改为”UEFI Only(仅UEFI模式)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724134519.jpg" alt></li>
<li>点击”Save &amp; Reset(保存 &amp; 重启)”,在弹出的对话框中选择”Yes(是)”重启电脑。如果出现如下对话框，选择”No(否)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724134545.jpg" alt></li>
</ol>
<h2 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h2><ol>
<li>将U盘插入服务器后的USB插槽中，重启服务器，进入下图所示界面。选择”Install Ubuntu Server(安装Ubuntu服务器版)”；<br>注:若无法进入下图所示界面，请进入BIOS修改U盘为第一启动项。<br><img src="/images/Ubuntu Server 16.04/IMG20180723165615.jpg" alt></li>
<li>选择安装过程和系统的默认语言为”English(英语)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165649.jpg" alt></li>
<li>“Select your location(选择你的区域)”，这里选择”Other(其他)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724153430.jpg" alt></li>
<li>“Continent or region(大陆或地区)”选择”Asia(亚洲)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724153439.jpg" alt></li>
<li>“Country(国家)”选择”China(中国)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724153448.jpg" alt></li>
<li>是否通过一系列的按键检测键盘布局，选择”NO(否)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165712.jpg" alt></li>
<li>字符集编码选择”United States -en_US.UTF-8”；<br><img src="/images/Ubuntu Server 16.04/IMG20180724153454.jpg" alt></li>
<li>“Country or Region for the keyboard(键盘布局所属国家或地区)”,选择”English(US)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165717.jpg" alt></li>
<li>“Keyboard layout(键盘布局)”，选择”English(US)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165725.jpg" alt></li>
<li>稍等片刻，将会显示出现错误,原因为:安装程序未检测到CD-ROM。是否重试，选择”No(否)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165744.jpg" alt></li>
<li>进入如下界面，选择”Execute a shell(运行shell)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165801.jpg" alt></li>
<li>在shell中依次输入如下命令:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ls /dev/sd*</span><br><span class="line">umount /dev/sdb4/</span><br><span class="line">mkdir udev</span><br><span class="line">mount /dev/sdb4 /udev</span><br><span class="line">mount /udev/ubuntu.iso /cdrom</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>一般会出现两个<code>/dev/sdb*</code>项，我们选择带数字的那一项去替换上面代码中的<code>/dev/sdb4</code>;<br><code>ubuntu.iso</code>为U盘中Ubuntu Server的ISO镜像的文件名”。<br><img src="/images/Ubuntu Server 16.04/IMG20180723165911.jpg" alt></p>
<ol start="13">
<li>进入如下界面后，选择”Detect and mount CD-ROM(探测并挂载光盘)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165919.jpg" alt></li>
<li>进入如下界面，选择”Network interface(网络接口)”，这里选择第一个网络接口，等待安装程序自动完成配置；<br><img src="/images/Ubuntu Server 16.04/IMG20180723165949.jpg" alt></li>
<li>设置”Hostname(主机名)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170037.jpg" alt></li>
<li>设置”Full name for the new user(新用户的全名)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170121.jpg" alt></li>
<li>设置”Username for your account(你账号的用户名)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170137.jpg" alt></li>
<li>设置”password for the new user(新用户的密码)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170145.jpg" alt></li>
<li>如果所设置的密码较为简单，可能会弹出如下对话框，询问你是否使用一个”weak password(弱口令)”，选择”Yes(是)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170157.jpg" alt></li>
<li>出现如下界面，询问你是否”Encrypt your home directory(加密你的主目录)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170208.jpg" alt></li>
<li>然后可能会出现时区设置错误，选择 “Continue(继续)”,进入如下界面，选择”Install the system(安装系统)”,然后直接回车，选择”Partion disks(磁盘分区)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170228.jpg" alt><br><img src="/images/Ubuntu Server 16.04/IMG20180723170234.jpg" alt></li>
<li>出现下图界面，询问你是否”Umount partitions that are in use(卸载正在使用的分区)”，选择”Yes(是)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170255.jpg" alt></li>
<li>选择”Partitioning method(分区方法)”，这里我们选择”Guided - use entire disk and set up LVM(使用整个磁盘并配置LVM)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170318.jpg" alt></li>
<li>“Select disk to partition(选择要分区的磁盘)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170325.jpg" alt></li>
<li>选择”Partitioning Scheme(分区方案) “，这里推荐选择”All files in one partition(所有文件放在同一分区)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170331.jpg" alt></li>
<li>出现如下界面，询问你是否”Write the changes to disks and configure LVM(将修改写入磁盘并配置LVM)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170342.jpg" alt></li>
<li>设置”Name of the volume group for the new system(新系统的卷组名)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170359.jpg" alt></li>
<li>设置”Amount of volume group to use for guided partitioning(用于分区引导的卷组数)”，默认大小即可，无需修改；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170421.jpg" alt></li>
<li>出现下图界面，询问你是否”Umount partitions that are in use(卸载正在使用的分区)”，选择”Yes(是)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170434.jpg" alt></li>
<li>出现如下界面，询问你是否”Force UEFI installation(强制UEFI安装)”，选择”Yes(是)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170442.jpg" alt></li>
<li>出现如下界面，询问是否”Write the changes to disks(将改动写入磁盘)”，选择”Yes(是)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170452.jpg" alt></li>
<li>“Kernel to install(要安装的内核)”,选择默认的”Linux-generic”即可；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170544.jpg" alt></li>
<li>回车后出现如下界面，这里要选择包含在initrd中的驱动程序，选择默认的”generic:include all available drivers(通用:包含所有可用的驱动程序)”即可；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170555.jpg" alt></li>
<li>“HTTP proxy information(HTTP代理信息)”不写，直接回车即可；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170657.jpg" alt></li>
<li>询问你管理系统更新的方式，选择”No automatic updates(不自动更新)”；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170737.jpg" alt></li>
<li>“Choose software to install(选择要安装的软件)”，建议勾选上”OpenSSh server”，然后回车;<br>选择方法为:通过键盘上下键移动光标至选要择项，在要选择的项上按空格即可；<br><img src="/images/Ubuntu Server 16.04/IMG20180724154325.jpg" alt></li>
<li>回车后，显示安装完成，继续回车，重启系统，此时就可以拔掉U盘；<br><img src="/images/Ubuntu Server 16.04/IMG20180723170940.jpg" alt></li>
<li>重启后，再次进入TDM，将”Boot Mode(引导模式)”改为”Legacy　Only(仅Legacy模式)”，否则有可能出现不能进入Linux系统的情况；</li>
</ol>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/976598171.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/976598171.html" class="post-title-link" itemprop="url">用C#爬虫爬取校园最新通知</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-20 17:55:22" itemprop="dateCreated datePublished" datetime="2018-06-20T17:55:22+08:00">2018-06-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C#</span>
                  </a>
                </span>
            </span>

          
            <span id="/976598171.html" class="post-meta-item leancloud_visitors" data-flag-title="用C#爬虫爬取校园最新通知" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前几个月用Python写了一个爬虫，用于爬取校园最新通知。最近的C#课程设计中想实现同样的功能，于是按照之前Python代码的思路重构了一下。<br><a href="https://zhaoqi99.github.io/45013.html" target="_blank" rel="noopener">用Python实现校园通知更新提醒</a></p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>使用C#中的HttpWebRequest库去获取目标url(各个网站的’更多通知’页)的源代码，然后使用<code>System.Text.RegularExpressions;</code>进行正则匹配。<br>正则表达式应包含三个分组:日期、标题、链接；</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>命名空间导入<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><p>Spider基类:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Spider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> url = <span class="keyword">string</span>.Empty;<span class="comment">//要爬取的网页的url</span></span><br><span class="line">    <span class="keyword">public</span> HttpWebRequest request;</span><br><span class="line">    <span class="keyword">public</span> HttpWebResponse response;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> encode = <span class="string">"UTF-8"</span>;<span class="comment">//目标url的网页编码格式</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Method = <span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Url</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> url; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            url = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Encode</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> encode; &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="string">"UTF-8"</span> || <span class="keyword">value</span> == <span class="string">"GBK"</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                encode = <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Todo:handle exception</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Spider</span>(<span class="params"><span class="keyword">string</span> url,<span class="keyword">string</span> method</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.Method = method;</span><br><span class="line">        Create();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Spider</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Create</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">        request.Method = Method;</span><br><span class="line">        request.Credentials = CredentialCache.DefaultCredentials;</span><br><span class="line">        request.UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取目标url的Html代码</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">getHtml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">string</span> reader = <span class="keyword">string</span>.Empty;</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">            Create();</span><br><span class="line">            response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">            <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                StreamReader sr = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), Encoding.GetEncoding(encode));</span><br><span class="line">                reader = sr.ReadToEnd();</span><br><span class="line">                sr.Close();</span><br><span class="line">                response.Close();<span class="comment">//关闭response响应流</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            Log.Write( e.Message, <span class="string">"Exception"</span>);</span><br><span class="line">            MessageBox.Show(e.Message, <span class="string">"错误"</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SpiderNotice类:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SpiderNotice</span> : <span class="title">Spider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> url_main;<span class="comment">//各个通知链接的公共部分</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> department;<span class="comment">//所属部门</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> type;<span class="comment">//通知类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> pattern;<span class="comment">//用于匹配的正则表达式规则</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList all_notice = <span class="keyword">new</span> ArrayList();<span class="comment">//所有的通知</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> parse = <span class="keyword">string</span>.Empty;<span class="comment">//日期的解析规则</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpiderNotice</span>(<span class="params"><span class="keyword">string</span> url, <span class="keyword">string</span> pattern, <span class="keyword">string</span> url_main, <span class="keyword">string</span> department, <span class="keyword">string</span> type</span>) : <span class="title">base</span>(<span class="params">url, <span class="string">"GET"</span></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.department = department;</span><br><span class="line">        <span class="keyword">this</span>.pattern = pattern;</span><br><span class="line">        <span class="keyword">this</span>.url_main = url_main;</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">        <span class="keyword">this</span>.parse = <span class="string">"yyyy-MM-dd"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        all_notice.Clear();</span><br><span class="line">        Regex r = <span class="keyword">new</span> Regex(pattern, RegexOptions.ExplicitCapture);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> s = getHtml();</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="string">"html"</span>);</span><br><span class="line">            MatchCollection mc = r.Matches(s);</span><br><span class="line">            <span class="keyword">foreach</span> (Match m <span class="keyword">in</span> mc)</span><br><span class="line">            &#123;</span><br><span class="line">                GroupCollection <span class="keyword">group</span> = m.Groups;</span><br><span class="line">                DateTime date = DateTime.ParseExact(<span class="keyword">group</span>[<span class="string">"date"</span>].Value, parse, System.Globalization.CultureInfo.InstalledUICulture);</span><br><span class="line">                <span class="keyword">string</span> link = url_main + <span class="keyword">group</span>[<span class="string">"link"</span>].Value;</span><br><span class="line">                Notice n = <span class="keyword">new</span> Notice();</span><br><span class="line">                n.Title = <span class="keyword">group</span>[<span class="string">"title"</span>].Value;</span><br><span class="line">                n.Link = link;</span><br><span class="line">                n.Date = date;</span><br><span class="line">                n.Department = department;</span><br><span class="line">                n.Type = type;</span><br><span class="line">                all_notice.Add(n);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            BLL.Log.Write(e.Message, <span class="string">"Exception"</span>);</span><br><span class="line">            MessageBox.Show(e.Message, <span class="string">"错误"</span>, MessageBoxButtons.OK, MessageBoxIcon.Error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Notice <span class="title">index</span>(<span class="params"><span class="keyword">int</span> index</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &gt;= all_notice.Count)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfRangeException();</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> all_notice[index] <span class="keyword">as</span> Notice;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Notice[] <span class="title">GetAll</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Notice[] All = <span class="keyword">new</span> Notice[all_notice.Count];</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">object</span> t <span class="keyword">in</span> all_notice)</span><br><span class="line">        &#123;</span><br><span class="line">            All[flag++] = t <span class="keyword">as</span> Notice;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> All;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">Count</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> all_notice.Count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>数据模型Notice类:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Notice</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">region</span> 数据模型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> title=<span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> link=<span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">private</span> DateTime date=DateTime.Now;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> type=<span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">string</span> department=<span class="keyword">string</span>.Empty;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Title</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> title;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            title = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> DateTime Date</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> date;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            date = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Link</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            link = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> link;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Type</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> type;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            type = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Department</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> department;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">set</span></span><br><span class="line">        &#123;</span><br><span class="line">            department = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">    <span class="function"><span class="keyword">override</span> <span class="keyword">public</span> <span class="keyword">string</span> <span class="title">ToString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">string</span>.Format(<span class="string">"标题:&#123;0&#125;\n时间:&#123;1&#125;\n链接:&#123;2&#125;\n"</span>, title, date.ToString(<span class="string">"yyyy-MM-dd"</span>), link);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="问题总结"><a href="#问题总结" class="headerlink" title="问题总结"></a>问题总结</h2><ul>
<li><p>从不同网站上爬取到的日期格式可能不同，为统一格式，可以使用｀DateTime.ParseExact(datastr, parse, System.Globalization.CultureInfo.InstalledUICulture);｀去解析用于表示日期的字符串，然后再转为统一日期格式的字符串。其中，datastr为表示日期的字符串，parse为解析规则。例:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> parse=<span class="string">"yyyy-M-D"</span>;</span><br><span class="line">DateTime t=DateTime.ParseExact(<span class="string">"2016-9-5"</span>, parse, System.Globalization.CultureInfo.InstalledUICulture);</span><br><span class="line"><span class="keyword">string</span> str=t.toString(<span class="string">"yyyy-MM-dd"</span>);<span class="comment">//2016-09-05</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>不用网页的网页编码格式可能不同，有的为GBK,有的问UTF-8;</p>
</li>
<li>用字符串去表达正则表达式的规则时，有两种方法:<ol>
<li>string s=@”\d+”””;字符串前加@表示字符串按常量解析(注意:双引号用两个双引号来表示)</li>
<li>string s=”\d+\””;使用转义符</li>
</ol>
</li>
</ul>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/1797370495.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/1797370495.html" class="post-title-link" itemprop="url">使用c#中的HttpWebRequest实现12306余票查询</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-19 02:41:13" itemprop="dateCreated datePublished" datetime="2018-06-19T02:41:13+08:00">2018-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C#</span>
                  </a>
                </span>
            </span>

          
            <span id="/1797370495.html" class="post-meta-item leancloud_visitors" data-flag-title="使用c#中的HttpWebRequest实现12306余票查询" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ol>
<li>下载用于解析JSON的类库(Newtonsoft.Json.dll)(下载地址:<a href="https://archive.codeplex.com/?p=json" target="_blank" rel="noopener">Newtonsoft.Json.dll</a>)；</li>
<li>在C#项目中添加对其的引用。</li>
<li>在程序中导入命名空间:<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="API地址"><a href="#API地址" class="headerlink" title="API地址"></a>API地址</h3><p>在浏览器中打开12306主页，点击<strong>余票查询</strong>，并使用浏览器中的开发者工具，进行抓包。这里，我们查询的是2018.06.25的上海至长沙的车票信息。<br><img src="/images/trainticket1.jpg" alt="开发者工具抓包"><br>此时浏览器发送请求的地址为：<br><code>https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=2018-06-25&amp;leftTicketDTO.from_station=SHH&amp;leftTicketDTO.to_station=CSQ&amp;purpose_codes=ADULT</code><br>由此,我们不难分析出API地址为：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> url=<span class="string">"https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=&#123;0&#125;&amp;leftTicketDTO.from_station=&#123;1&#125;&amp;leftTicketDTO.to_station=&#123;2&#125;&amp;purpose_codes=&#123;3&#125;"</span>;</span><br><span class="line">url=<span class="keyword">string</span>.Format(url,date,<span class="keyword">from</span>,to,id);</span><br></pre></td></tr></table></figure></p>
<p>其中，date代表出发日(格式为yyyy-MM-dd),from代表出发站的代码，to代表到达站的代码，id代表车票类型(成人为<code>ADULT</code>,学生为<code>OX00</code>);</p>
<h3 id="车站代码"><a href="#车站代码" class="headerlink" title="车站代码"></a>车站代码</h3><p>车站对应的代码可在此下载:<a href="https://kyfw.12306.cn/otn/resources/js/framework/station_name.js?station_version=1.9055" target="_blank" rel="noopener">https://kyfw.12306.cn/otn/resources/js/framework/station_name.js?station_version=1.9055</a><br>我们可以使用正则表达式从中提取出关键信息，并保存在一个XML文档中，便于以后的使用。<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StationNameXml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>     &#123;</span><br><span class="line">         <span class="keyword">string</span> nowpath = Environment.CurrentDirectory;</span><br><span class="line">         <span class="keyword">if</span> (Directory.Exists(nowpath+<span class="string">"/Data"</span>)==<span class="literal">false</span>)</span><br><span class="line">             Directory.CreateDirectory(nowpath + <span class="string">"/Data"</span>);<span class="comment">//创建新路径</span></span><br><span class="line">         <span class="keyword">if</span> (File.Exists(nowpath + <span class="string">"/Data/StationName.xml"</span>) == <span class="literal">true</span>)</span><br><span class="line">             <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">HttpWebRequest request;</span><br><span class="line">  		HttpWebResponse response;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">string</span> url=<span class="string">@"https://kyfw.12306.cn/otn/resources/js/framework/station_name.js?station_version=1.9055"</span>;</span><br><span class="line"></span><br><span class="line">         request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">         request.Method = <span class="string">"GET"</span>;</span><br><span class="line">         request.Credentials = CredentialCache.DefaultCredentials;</span><br><span class="line">         request.UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36"</span>;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">string</span> str = <span class="keyword">string</span>.Empty;</span><br><span class="line">         <span class="keyword">try</span></span><br><span class="line">         &#123;</span><br><span class="line">             response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">             <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">             &#123;</span><br><span class="line">                 StreamReader sr = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), Encoding.GetEncoding(<span class="string">"UTF-8"</span>));</span><br><span class="line">                 str = sr.ReadToEnd();</span><br><span class="line">                 sr.Close();</span><br><span class="line">                 response.Close();<span class="comment">//关闭response响应流</span></span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">else</span></span><br><span class="line">                 <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span>(Exception e)</span><br><span class="line">         &#123;</span><br><span class="line">	Console.WriteLine(e.Message);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">string</span> pattern = <span class="string">@"@\S&#123;2,5&#125;?[|](?&lt;Name&gt;\S&#123;1,8&#125;?)[|](?&lt;Code&gt;\S&#123;3,5&#125;?)[|]"</span>;</span><br><span class="line">         Regex r = <span class="keyword">new</span> Regex(pattern, RegexOptions.ExplicitCapture);</span><br><span class="line"></span><br><span class="line">         XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">         XmlDeclaration xmldecl;</span><br><span class="line"></span><br><span class="line">         xmldecl = xmldoc.CreateXmlDeclaration(<span class="string">"1.0"</span>, <span class="string">"UTF-8"</span>, <span class="literal">null</span>);<span class="comment">//加入XML的声明段落</span></span><br><span class="line">         xmldoc.AppendChild(xmldecl);</span><br><span class="line"></span><br><span class="line">         XmlElement root = xmldoc.CreateElement(<span class="string">""</span>, <span class="string">"Dict"</span>, <span class="string">""</span>);<span class="comment">//加入一个根元素</span></span><br><span class="line">         xmldoc.AppendChild(root);</span><br><span class="line"></span><br><span class="line">         MatchCollection mc = r.Matches(str);</span><br><span class="line">         <span class="keyword">foreach</span> (Match m <span class="keyword">in</span> mc)</span><br><span class="line">         &#123;</span><br><span class="line">             GroupCollection <span class="keyword">group</span> = m.Groups;</span><br><span class="line">             XmlNode node = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Pair"</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">             XmlNode temp = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Station"</span>, <span class="literal">null</span>);</span><br><span class="line">             temp.InnerText = <span class="keyword">group</span>[<span class="string">"Name"</span>].Value; </span><br><span class="line">             node.AppendChild(temp);</span><br><span class="line"></span><br><span class="line">             XmlNode temp2 = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Code"</span>, <span class="literal">null</span>);</span><br><span class="line">             temp2.InnerText = <span class="keyword">group</span>[<span class="string">"Code"</span>].Value;</span><br><span class="line">             node.AppendChild(temp2);</span><br><span class="line"></span><br><span class="line">             root.AppendChild(node);</span><br><span class="line">         &#125;</span><br><span class="line">         xmldoc.Save(nowpath+<span class="string">"/Data/"</span>+<span class="string">"StationName.xml"</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/trainticket2.jpg" alt="车站代码"><br>依据中文车站名获取对应车站代码的方法为:<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">StationCode</span>(<span class="params"><span class="keyword">string</span> StationName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    XmlDocument doc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">    doc.Load(Environment.CurrentDirectory + <span class="string">"/Data/StationName.xml"</span>);</span><br><span class="line">    XmlNodeList data = doc.DocumentElement.ChildNodes;</span><br><span class="line">    <span class="keyword">foreach</span> (XmlNode node <span class="keyword">in</span> data)</span><br><span class="line">    &#123;</span><br><span class="line">        XmlElement xe = (XmlElement)node;</span><br><span class="line">        XmlNodeList xnl0 = xe.ChildNodes;</span><br><span class="line">        <span class="keyword">string</span> s = xnl0.Item(<span class="number">0</span>).InnerText;</span><br><span class="line">        <span class="keyword">if</span>(s==StationName)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> xnl0.Item(<span class="number">1</span>).InnerText;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>.Empty;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>为了存储查询结果，我们需要构建一个车票的数据模型，具体如下；<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Ticket</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">region</span> 数据模型</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> trainid=<span class="keyword">string</span>.Empty;<span class="comment">//车次</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> fromstation = <span class="string">"--"</span>;<span class="comment">//出发站</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> totation = <span class="string">"--"</span>;<span class="comment">//到达站</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> ticketdate = <span class="keyword">string</span>.Empty;<span class="comment">//车票日期</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> starttime = <span class="string">"--"</span>;<span class="comment">//发车时间</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> arrivetime = <span class="string">"--"</span>;<span class="comment">//到达时间</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> lastedtime = <span class="string">"--"</span>;<span class="comment">//历时</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> tzNum = <span class="string">"--"</span>;<span class="comment">//特等座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> ydNum = <span class="string">"--"</span>;<span class="comment">//一等座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> edNum = <span class="string">"--"</span>;<span class="comment">//二等座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> grwNum = <span class="string">"--"</span>;<span class="comment">//高级软卧</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> rwNum = <span class="string">"--"</span>;<span class="comment">//软卧</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> dwNum = <span class="string">"--"</span>;<span class="comment">//动卧</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> ywNum = <span class="string">"--"</span>;<span class="comment">//硬卧</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> rzNum = <span class="string">"--"</span>;<span class="comment">//软座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> yzNum = <span class="string">"--"</span>;<span class="comment">//硬座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> wzNum = <span class="string">"--"</span>;<span class="comment">//无座</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> qtNum = <span class="string">"--"</span>;<span class="comment">//其他</span></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">string</span> identity = <span class="keyword">string</span>.Empty;<span class="comment">//车票类型(学生/成人)</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> TrainId &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> trainid; &#125; <span class="keyword">set</span> &#123; trainid = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> FromStation &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> fromstation; &#125; <span class="keyword">set</span> &#123; fromstation = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> ToStation &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> totation; &#125; <span class="keyword">set</span> &#123; totation = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> TicketDate &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> ticketdate; &#125; <span class="keyword">set</span> &#123; ticketdate = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> StartTime &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> starttime; &#125; <span class="keyword">set</span> &#123; starttime = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> ArriveTime &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> arrivetime; &#125;<span class="keyword">set</span> &#123; arrivetime = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> LastedTime &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> lastedtime; &#125; <span class="keyword">set</span> &#123; lastedtime = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> TzNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> tzNum; &#125; <span class="keyword">set</span> &#123; tzNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> YdNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> ydNum; &#125; <span class="keyword">set</span> &#123; ydNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> EdNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> edNum; &#125; <span class="keyword">set</span> &#123; edNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> GrwNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> grwNum; &#125; <span class="keyword">set</span> &#123; grwNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> RwNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> rwNum; &#125; <span class="keyword">set</span> &#123; rwNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> DwNum &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> dwNum; &#125; <span class="keyword">set</span> &#123; dwNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> YwNum &#123;<span class="keyword">get</span>&#123; <span class="keyword">return</span> ywNum; &#125;<span class="keyword">set</span>&#123; ywNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> RzNum &#123;<span class="keyword">get</span>&#123; <span class="keyword">return</span> rzNum; &#125;<span class="keyword">set</span>&#123; rzNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> YzNum &#123;<span class="keyword">get</span>&#123; <span class="keyword">return</span> yzNum; &#125;<span class="keyword">set</span>&#123; yzNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> WzNum &#123;<span class="keyword">get</span>&#123; <span class="keyword">return</span> wzNum; &#125;<span class="keyword">set</span>&#123; wzNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> QtNum &#123;<span class="keyword">get</span>&#123; <span class="keyword">return</span> qtNum; &#125;<span class="keyword">set</span>&#123; qtNum = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">string</span> Identity &#123; <span class="keyword">get</span> &#123; <span class="keyword">return</span> identity; &#125;<span class="keyword">set</span> &#123; identity = <span class="keyword">value</span>; &#125; &#125;</span><br><span class="line">       <span class="meta">#<span class="meta-keyword">endregion</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">Ticket</span>(<span class="params"></span>)</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; <span class="title">getMap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; result = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">           result.Add(<span class="string">"车次"</span>, trainid);</span><br><span class="line">           result.Add(<span class="string">"出发站"</span>, FromStation);</span><br><span class="line">           result.Add(<span class="string">"到达站"</span>, ToStation);</span><br><span class="line">           result.Add(<span class="string">"发车时间"</span>, StartTime);</span><br><span class="line">           result.Add(<span class="string">"到达时间"</span>, ArriveTime);</span><br><span class="line">           result.Add(<span class="string">"历时"</span>, LastedTime);</span><br><span class="line">           result.Add(<span class="string">"特等座"</span>, TzNum);</span><br><span class="line">           result.Add(<span class="string">"一等座"</span>, YdNum);</span><br><span class="line">           result.Add(<span class="string">"二等座"</span>, EdNum);</span><br><span class="line">           result.Add(<span class="string">"高级软卧"</span>, GrwNum);</span><br><span class="line">           result.Add(<span class="string">"软卧"</span>, RwNum);</span><br><span class="line">           result.Add(<span class="string">"动卧"</span>, DwNum);</span><br><span class="line">           result.Add(<span class="string">"硬卧"</span>, YwNum);</span><br><span class="line">           result.Add(<span class="string">"软座"</span>, RzNum);</span><br><span class="line">           result.Add(<span class="string">"硬座"</span>, YzNum);</span><br><span class="line">           result.Add(<span class="string">"无座"</span>, WzNum);</span><br><span class="line">           result.Add(<span class="string">"其他"</span>, QtNum);</span><br><span class="line">           <span class="keyword">return</span> result;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="解析JSON"><a href="#解析JSON" class="headerlink" title="解析JSON"></a>解析JSON</h3><p><img src="/images/trainticket3.jpg" alt="JSON格式的字符串"><br>返回的报文为一个JSON格式的字符串，里面包含有各类车票信息、发车时间以及历时，为了对其进行解析，我们需要下载一个用于解析JSON的类库(下载地址:<a href="https://archive.codeplex.com/?p=json" target="_blank" rel="noopener">Newtonsoft.Json.dll</a>)<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Ticket[] <span class="title">SpiderTicket</span>(<span class="params"><span class="keyword">string</span> date, <span class="keyword">string</span> <span class="keyword">from</span>, <span class="keyword">string</span> to, <span class="keyword">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">     HttpWebRequest request;</span><br><span class="line">     HttpWebResponse response;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">string</span> url = <span class="string">"https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=&#123;0&#125;&amp;leftTicketDTO.from_station=&#123;1&#125;&amp;leftTicketDTO.to_station=&#123;2&#125;&amp;purpose_codes=&#123;3&#125;"</span>;</span><br><span class="line">     url = <span class="keyword">string</span>.Format(url, date, <span class="keyword">from</span>, to, id);</span><br><span class="line"></span><br><span class="line">     request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">     request.Method = <span class="string">"GET"</span>;</span><br><span class="line">     request.Credentials = CredentialCache.DefaultCredentials;</span><br><span class="line">     request.UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36"</span>;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">string</span> str = <span class="keyword">string</span>.Empty;</span><br><span class="line">     <span class="keyword">try</span></span><br><span class="line">     &#123;</span><br><span class="line">         response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">         <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">         &#123;</span><br><span class="line">             StreamReader sr = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), Encoding.GetEncoding(<span class="string">"UTF-8"</span>));</span><br><span class="line">             str = sr.ReadToEnd();</span><br><span class="line">             sr.Close();</span><br><span class="line">             response.Close();<span class="comment">//关闭response响应流</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">catch</span> (Exception e)</span><br><span class="line">     &#123;</span><br><span class="line">         Console.WriteLine(e.Message);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; map=<span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();<span class="comment">//保存返回的JSON串中的车站代码与车站名之间的映</span></span><br><span class="line">     ArrayList AllTicket = <span class="keyword">new</span> ArrayList();<span class="comment">//所有的车票信息</span></span><br><span class="line"></span><br><span class="line">     JObject jo = (JObject)JsonConvert.DeserializeObject(str);</span><br><span class="line">     JToken record = jo[<span class="string">"data"</span>][<span class="string">"map"</span>];</span><br><span class="line">     <span class="keyword">foreach</span> (JProperty item <span class="keyword">in</span> record)</span><br><span class="line">     &#123;</span><br><span class="line">         map.Add(item.Name.ToString(), item.Value.ToString());</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     record = jo[<span class="string">"data"</span>][<span class="string">"result"</span>];</span><br><span class="line">     <span class="keyword">foreach</span> (<span class="keyword">string</span> s <span class="keyword">in</span> record)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">string</span>[] result = s.Split(<span class="string">'|'</span>);</span><br><span class="line">         Ticket t = <span class="keyword">new</span> Ticket();</span><br><span class="line">         t.TrainId = result[<span class="number">3</span>];</span><br><span class="line">         t.FromStation = map[result[<span class="number">6</span>]];</span><br><span class="line">         t.ToStation = map[result[<span class="number">7</span>]];</span><br><span class="line">         t.StartTime = result[<span class="number">8</span>];</span><br><span class="line">         t.ArriveTime = result[<span class="number">9</span>];</span><br><span class="line">         t.LastedTime = result[<span class="number">10</span>];</span><br><span class="line">         t.TicketDate = result[<span class="number">13</span>];</span><br><span class="line">         t.DwNum = result[<span class="number">33</span>] != <span class="string">""</span> ? result[<span class="number">33</span>] : t.DwNum;</span><br><span class="line">         t.TzNum = result[<span class="number">32</span>] != <span class="string">""</span> ? result[<span class="number">32</span>] : t.TzNum;</span><br><span class="line">         t.YdNum = result[<span class="number">31</span>] != <span class="string">""</span> ? result[<span class="number">31</span>] : t.YdNum;</span><br><span class="line">         t.EdNum = result[<span class="number">30</span>] != <span class="string">""</span> ? result[<span class="number">30</span>] : t.EdNum;</span><br><span class="line">         t.YzNum = result[<span class="number">29</span>] != <span class="string">""</span> ? result[<span class="number">29</span>] : t.YzNum;</span><br><span class="line">         t.YwNum = result[<span class="number">28</span>] != <span class="string">""</span> ? result[<span class="number">28</span>] : t.YwNum;</span><br><span class="line">         t.WzNum = result[<span class="number">26</span>] != <span class="string">""</span> ? result[<span class="number">26</span>] : t.WzNum;</span><br><span class="line">         t.RzNum = result[<span class="number">24</span>] != <span class="string">""</span> ? result[<span class="number">24</span>] : t.RzNum;</span><br><span class="line">         t.RwNum = result[<span class="number">23</span>] != <span class="string">""</span> ? result[<span class="number">23</span>] : t.RwNum;</span><br><span class="line">         t.GrwNum = result[<span class="number">21</span>] != <span class="string">""</span> ? result[<span class="number">21</span>] : t.GrwNum;</span><br><span class="line">         AllTicket.Add(t);</span><br><span class="line">     &#125;</span><br><span class="line">     Ticket[] All = <span class="keyword">new</span> Ticket[AllTicket.Count];</span><br><span class="line">     <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">foreach</span> (<span class="keyword">object</span> t <span class="keyword">in</span> AllTicket)</span><br><span class="line">     &#123;</span><br><span class="line">         All[flag++] = t <span class="keyword">as</span> Ticket;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> All;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="/images/spiderticket.jpg" alt><br><img src="/images/spiderticket2.jpg" alt><br>项目地址:<a href="https://github.com/ZhaoQi99/EasyLife/tree/Course_Design/" target="_blank" rel="noopener">EasyLife</a></p>
<h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><p><a href="https://blog.csdn.net/xiahn1a/article/details/42584507" target="_blank" rel="noopener">C#调用12306API做余票查询</a>(该参考博客中的方法已不可用)</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Newtonsoft.Json;</span><br><span class="line"><span class="keyword">using</span> Newtonsoft.Json.Linq;</span><br><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Net;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Text.RegularExpressions;</span><br><span class="line"><span class="keyword">using</span> System.Xml;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Ticket</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">StationNameXml</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">string</span> nowpath = Environment.CurrentDirectory;</span><br><span class="line">            <span class="keyword">if</span> (Directory.Exists(nowpath + <span class="string">"/Data"</span>) == <span class="literal">false</span>)</span><br><span class="line">                Directory.CreateDirectory(nowpath + <span class="string">"/Data"</span>);<span class="comment">//创建新路径</span></span><br><span class="line">            <span class="keyword">if</span> (File.Exists(nowpath + <span class="string">"/Data/StationName.xml"</span>) == <span class="literal">true</span>)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            HttpWebRequest request;</span><br><span class="line">            HttpWebResponse response;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> url = <span class="string">@"https://kyfw.12306.cn/otn/resources/js/framework/station_name.js?station_version=1.9055"</span>;</span><br><span class="line"></span><br><span class="line">            request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">            request.Method = <span class="string">"GET"</span>;</span><br><span class="line">            request.Credentials = CredentialCache.DefaultCredentials;</span><br><span class="line">            request.UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> str = <span class="keyword">string</span>.Empty;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">                <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    StreamReader sr = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), Encoding.GetEncoding(<span class="string">"UTF-8"</span>));</span><br><span class="line">                    str = sr.ReadToEnd();</span><br><span class="line">                    sr.Close();</span><br><span class="line">                    response.Close();<span class="comment">//关闭response响应流</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> pattern = <span class="string">@"@\S&#123;2,5&#125;?[|](?&lt;Name&gt;\S&#123;1,8&#125;?)[|](?&lt;Code&gt;\S&#123;3,5&#125;?)[|]"</span>;</span><br><span class="line">            Regex r = <span class="keyword">new</span> Regex(pattern, RegexOptions.ExplicitCapture);</span><br><span class="line"></span><br><span class="line">            XmlDocument xmldoc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">            XmlDeclaration xmldecl;</span><br><span class="line"></span><br><span class="line">            xmldecl = xmldoc.CreateXmlDeclaration(<span class="string">"1.0"</span>, <span class="string">"UTF-8"</span>, <span class="literal">null</span>);<span class="comment">//加入XML的声明段落</span></span><br><span class="line">            xmldoc.AppendChild(xmldecl);</span><br><span class="line"></span><br><span class="line">            XmlElement root = xmldoc.CreateElement(<span class="string">""</span>, <span class="string">"Dict"</span>, <span class="string">""</span>);<span class="comment">//加入一个根元素</span></span><br><span class="line">            xmldoc.AppendChild(root);</span><br><span class="line"></span><br><span class="line">            MatchCollection mc = r.Matches(str);</span><br><span class="line">            <span class="keyword">foreach</span> (Match m <span class="keyword">in</span> mc)</span><br><span class="line">            &#123;</span><br><span class="line">                GroupCollection <span class="keyword">group</span> = m.Groups;</span><br><span class="line">                XmlNode node = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Pair"</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">                XmlNode temp = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Station"</span>, <span class="literal">null</span>);</span><br><span class="line">                temp.InnerText = <span class="keyword">group</span>[<span class="string">"Name"</span>].Value;</span><br><span class="line">                node.AppendChild(temp);</span><br><span class="line"></span><br><span class="line">                XmlNode temp2 = xmldoc.CreateNode(XmlNodeType.Element, <span class="string">"Code"</span>, <span class="literal">null</span>);</span><br><span class="line">                temp2.InnerText = <span class="keyword">group</span>[<span class="string">"Code"</span>].Value;</span><br><span class="line">                node.AppendChild(temp2);</span><br><span class="line"></span><br><span class="line">                root.AppendChild(node);</span><br><span class="line">            &#125;</span><br><span class="line">            xmldoc.Save(nowpath + <span class="string">"/Data/"</span> + <span class="string">"StationName.xml"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">StationCode</span>(<span class="params"><span class="keyword">string</span> StationName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            XmlDocument doc = <span class="keyword">new</span> XmlDocument();</span><br><span class="line">            doc.Load(Environment.CurrentDirectory + <span class="string">"/Data/StationName.xml"</span>);</span><br><span class="line">            XmlNodeList data = doc.DocumentElement.ChildNodes;</span><br><span class="line">            <span class="keyword">foreach</span> (XmlNode node <span class="keyword">in</span> data)</span><br><span class="line">            &#123;</span><br><span class="line">                XmlElement xe = (XmlElement)node;</span><br><span class="line">                XmlNodeList xnl0 = xe.ChildNodes;</span><br><span class="line">                <span class="keyword">string</span> s = xnl0.Item(<span class="number">0</span>).InnerText;</span><br><span class="line">                <span class="keyword">if</span> (s == StationName)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> xnl0.Item(<span class="number">1</span>).InnerText;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Ticket[] <span class="title">SpiderTicket</span>(<span class="params"><span class="keyword">string</span> date, <span class="keyword">string</span> <span class="keyword">from</span>, <span class="keyword">string</span> to, <span class="keyword">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            HttpWebRequest request;</span><br><span class="line">            HttpWebResponse response;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> url = <span class="string">"https://kyfw.12306.cn/otn/leftTicket/query?leftTicketDTO.train_date=&#123;0&#125;&amp;leftTicketDTO.from_station=&#123;1&#125;&amp;leftTicketDTO.to_station=&#123;2&#125;&amp;purpose_codes=&#123;3&#125;"</span>;</span><br><span class="line">            url = <span class="keyword">string</span>.Format(url, date, <span class="keyword">from</span>, to, id);</span><br><span class="line"></span><br><span class="line">            request = (HttpWebRequest)WebRequest.Create(url);</span><br><span class="line">            request.Method = <span class="string">"GET"</span>;</span><br><span class="line">            request.Credentials = CredentialCache.DefaultCredentials;</span><br><span class="line">            request.UserAgent = <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">string</span> str = <span class="keyword">string</span>.Empty;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">                <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">                &#123;</span><br><span class="line">                    StreamReader sr = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), Encoding.GetEncoding(<span class="string">"UTF-8"</span>));</span><br><span class="line">                    str = sr.ReadToEnd();</span><br><span class="line">                    sr.Close();</span><br><span class="line">                    response.Close();<span class="comment">//关闭response响应流</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Exception e)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(e.Message);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; map=<span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();<span class="comment">//保存返回的JSON串中的车站代码与车站名之间的映</span></span><br><span class="line">            ArrayList AllTicket = <span class="keyword">new</span> ArrayList();<span class="comment">//所有的车票信息</span></span><br><span class="line"></span><br><span class="line">            JObject jo = (JObject)JsonConvert.DeserializeObject(str);</span><br><span class="line">            JToken record = jo[<span class="string">"data"</span>][<span class="string">"map"</span>];</span><br><span class="line">            <span class="keyword">foreach</span> (JProperty item <span class="keyword">in</span> record)</span><br><span class="line">            &#123;</span><br><span class="line">                map.Add(item.Name.ToString(), item.Value.ToString());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            record = jo[<span class="string">"data"</span>][<span class="string">"result"</span>];</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">string</span> s <span class="keyword">in</span> record)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">string</span>[] result = s.Split(<span class="string">'|'</span>);</span><br><span class="line">                Ticket t = <span class="keyword">new</span> Ticket();</span><br><span class="line">                t.TrainId = result[<span class="number">3</span>];</span><br><span class="line">                t.FromStation = map[result[<span class="number">6</span>]];</span><br><span class="line">                t.ToStation = map[result[<span class="number">7</span>]];</span><br><span class="line">                t.StartTime = result[<span class="number">8</span>];</span><br><span class="line">                t.ArriveTime = result[<span class="number">9</span>];</span><br><span class="line">                t.LastedTime = result[<span class="number">10</span>];</span><br><span class="line">                t.TicketDate = result[<span class="number">13</span>];</span><br><span class="line">                t.DwNum = result[<span class="number">33</span>] != <span class="string">""</span> ? result[<span class="number">33</span>] : t.DwNum;</span><br><span class="line">                t.TzNum = result[<span class="number">32</span>] != <span class="string">""</span> ? result[<span class="number">32</span>] : t.TzNum;</span><br><span class="line">                t.YdNum = result[<span class="number">31</span>] != <span class="string">""</span> ? result[<span class="number">31</span>] : t.YdNum;</span><br><span class="line">                t.EdNum = result[<span class="number">30</span>] != <span class="string">""</span> ? result[<span class="number">30</span>] : t.EdNum;</span><br><span class="line">                t.YzNum = result[<span class="number">29</span>] != <span class="string">""</span> ? result[<span class="number">29</span>] : t.YzNum;</span><br><span class="line">                t.YwNum = result[<span class="number">28</span>] != <span class="string">""</span> ? result[<span class="number">28</span>] : t.YwNum;</span><br><span class="line">                t.WzNum = result[<span class="number">26</span>] != <span class="string">""</span> ? result[<span class="number">26</span>] : t.WzNum;</span><br><span class="line">                t.RzNum = result[<span class="number">24</span>] != <span class="string">""</span> ? result[<span class="number">24</span>] : t.RzNum;</span><br><span class="line">                t.RwNum = result[<span class="number">23</span>] != <span class="string">""</span> ? result[<span class="number">23</span>] : t.RwNum;</span><br><span class="line">                t.GrwNum = result[<span class="number">21</span>] != <span class="string">""</span> ? result[<span class="number">21</span>] : t.GrwNum;</span><br><span class="line">                AllTicket.Add(t);</span><br><span class="line">            &#125;</span><br><span class="line">            Ticket[] All = <span class="keyword">new</span> Ticket[AllTicket.Count];</span><br><span class="line">            <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">object</span> t <span class="keyword">in</span> AllTicket)</span><br><span class="line">            &#123;</span><br><span class="line">                All[flag++] = t <span class="keyword">as</span> Ticket;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> All;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            StationNameXml();</span><br><span class="line">            <span class="keyword">string</span> <span class="keyword">from</span> = <span class="string">"上海"</span>;</span><br><span class="line">            <span class="keyword">string</span> to = <span class="string">"北京"</span>;</span><br><span class="line">            Ticket[] All=<span class="keyword">new</span> Ticket[<span class="number">50</span>];</span><br><span class="line">            All=SpiderTicket(DateTime.Now.ToString(<span class="string">"yyyy-MM-dd"</span>), StationCode(<span class="keyword">from</span>), StationCode(to), <span class="string">"ADULT"</span>);</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;All.Length;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt; map = <span class="keyword">new</span> Dictionary&lt;<span class="keyword">string</span>, <span class="keyword">string</span>&gt;();</span><br><span class="line">                map = All[i].getMap();</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">object</span> j <span class="keyword">in</span> map.Keys)</span><br><span class="line">                    Console.Write(j.ToString()+<span class="string">":"</span>+map[j.ToString()].ToString()+<span class="string">" "</span>);</span><br><span class="line">                Console.WriteLine();</span><br><span class="line">            &#125;</span><br><span class="line">            Console.Read();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/3123403799.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/3123403799.html" class="post-title-link" itemprop="url">C#中使用SmtpClient发送邮件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-19 02:41:13" itemprop="dateCreated datePublished" datetime="2018-06-19T02:41:13+08:00">2018-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C#</span>
                  </a>
                </span>
            </span>

          
            <span id="/3123403799.html" class="post-meta-item leancloud_visitors" data-flag-title="C#中使用SmtpClient发送邮件" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近写C#课程设计时需要用C#来发送邮件，但是网上搜的代码经过测试均不能使用，调试了很久也没能成功。最后索性自己对着官方文档撸了一个，期间踩了很多坑，故在此做一总结。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>命名空间导入:<code>using System.Net.Mail;</code></li>
<li>在邮箱设置中开通smtp服务，并获取授权码。</li>
</ul>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> mailfrom, password, fromwho, host, mailto, subject, body;</span><br><span class="line">mailfrom = <span class="string">"xxx@qq.com"</span>;<span class="comment">//发件人</span></span><br><span class="line"><span class="keyword">int</span> port = <span class="number">25</span>;<span class="comment">//端口号一般为25</span></span><br><span class="line">password = <span class="string">"**********"</span>;<span class="comment">//邮箱密码</span></span><br><span class="line">host = <span class="string">"smtp.xxx.com"</span>;<span class="comment">//主机地址</span></span><br><span class="line">fromwho = <span class="string">"xxx"</span>;<span class="comment">//发件人的签名</span></span><br><span class="line">mailto = <span class="string">"xxx@qq.com"</span>;<span class="comment">//收件人(多个收件人之间以英文逗号间隔)</span></span><br><span class="line">subject = <span class="string">"test"</span>;<span class="comment">//邮件主题</span></span><br><span class="line">body = <span class="string">"xxxxx"</span>;<span class="comment">//邮件正文</span></span><br><span class="line"></span><br><span class="line">SmtpClient smtp;</span><br><span class="line">smtp = <span class="keyword">new</span> SmtpClient(host, port);</span><br><span class="line">smtp.UseDefaultCredentials = <span class="literal">false</span>;</span><br><span class="line">smtp.EnableSsl = <span class="literal">true</span>;<span class="comment">//是否使用SSL加密连接</span></span><br><span class="line">smtp.DeliveryMethod = SmtpDeliveryMethod.Network;<span class="comment">//指定邮件发送方式</span></span><br><span class="line">smtp.Credentials = <span class="keyword">new</span> System.Net.NetworkCredential(mailfrom, password); <span class="comment">//设置用于验证发件人身份的凭证</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">string</span>[] address = mailto.Split(<span class="string">','</span>);<span class="comment">//收件人地址列表</span></span><br><span class="line">MailMessage msg = <span class="keyword">new</span> MailMessage();<span class="comment">//邮件信息</span></span><br><span class="line">msg.From = <span class="keyword">new</span> MailAddress(mailfrom, fromwho, Encoding.UTF8);</span><br><span class="line">msg.Subject = subject;<span class="comment">//邮件标题</span></span><br><span class="line">msg.SubjectEncoding = Encoding.UTF8;</span><br><span class="line">msg.Body = body;<span class="comment">//邮件正文</span></span><br><span class="line">msg.BodyEncoding = Encoding.UTF8;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; address.Length; i++)</span><br><span class="line">    msg.To.Add(address[i]);</span><br><span class="line"></span><br><span class="line">msg.Priority = MailPriority.Normal;<span class="comment">//邮件优先级(High,Low,Normal)</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">&#123;</span><br><span class="line">    smtp.Send(msg);</span><br><span class="line">	Console.WriteLine(<span class="string">"发送成功!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (Exception e)</span><br><span class="line">&#123;</span><br><span class="line">    Console.WriteLine(e.Message);</span><br><span class="line">&#125;</span><br><span class="line">msg.Dispose();</span><br></pre></td></tr></table></figure>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul>
<li>代码中所使用的密码不是邮箱密码，应在邮箱设置中获取smtp服务授权码。</li>
<li>使用163邮箱时只能使用25端口(465/994不可用),EnableSsl属性设置为false/true</li>
<li>使用QQ邮箱发送时只能使用25端口(465/587不可用),且EnableSsl属性必须设置为true</li>
<li>代码使用QQ邮箱、163邮箱实测有效，其他邮箱尚不清楚</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>无论是QQ邮箱还是163邮箱，使用SSL端口发送时均出现异常：操作超时，查了好久，发现是因为:System.Net.Mail只支持显式SSL(Explicit SSL)，但是不支持隐式SSL(Implicit SSL)，QQ邮箱使用的应该是Implicit SSL。此问题似乎可以用<code>System.Web.Mail</code>或<code>Cdosys.dll</code>解决，但是还没有试过。<br>关于QQ邮箱使用25端口发送时，必须使用设置SSL为true的原因:服务器从不受保护的25端口响应请求，然后将连接抛到受保护的465端口.<br><strong>显式SSL</strong>通过25端口连接 - &gt; StartTLS（开始加密）- &gt;验证 - &gt;发送数据<br><strong>隐式SSL</strong>StartSSL（开始加密） - &gt; 连接 - &gt; 验证 - &gt;发送数据</p>
<h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><p><a href="https://blog.csdn.net/andrewniu/article/details/52594318" target="_blank" rel="noopener">C#发送邮件三种方法，Localhost，SMTP，SSL-SMTP</a><br><a href="https://blogs.msdn.microsoft.com/webdav_101/2008/06/02/system-net-mail-with-ssl-to-authenticate-against-port-465/" target="_blank" rel="noopener">System.Net.Mail with SSL to authenticate against port 465</a><br><a href="https://support.microsoft.com/en-us/help/950260/you-cannot-use-system-net-mail-smtpclient-to-send-an-e-mail-message-wi" target="_blank" rel="noopener">You cannot use System.Net.Mail.SmtpClient to send an e-mail message with Implicit SSL</a></p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/1000607951.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/1000607951.html" class="post-title-link" itemprop="url">C#中自己生成验证码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-19 02:41:13" itemprop="dateCreated datePublished" datetime="2018-06-19T02:41:13+08:00">2018-06-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C#</span>
                  </a>
                </span>
            </span>

          
            <span id="/1000607951.html" class="post-meta-item leancloud_visitors" data-flag-title="C#中自己生成验证码" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近写C#课程设计时，登录验证处需用到验证码，于是参照网上博客，自己封装了一个验证码类，和网上其他博客相比，有以下优点:</p>
<ul>
<li>去除了0,o,O与1,l等容易混淆的字符</li>
<li>使用方便，仅需三行代码</li>
<li>内置有返回MD5加密后的字符串的方法，便于前端调用</li>
</ul>
<h2 id="函数说明"><a href="#函数说明" class="headerlink" title="函数说明"></a>函数说明</h2><h3 id="公有方法"><a href="#公有方法" class="headerlink" title="公有方法"></a>公有方法</h3><ul>
<li>SecurityCode(int length);//构造函数</li>
<li>SecurityCode(int length, int width, int height);//构造函数</li>
<li>void UpdateVerifyCode();//刷新验证码</li>
<li>Bitmap getImage();//返回验证码图片</li>
<li>string MD5Encrypt();//返回经MD5加密过的验证码字符串</li>
<li>bool Check(string text);//返回校验结果(不区分大小写)</li>
</ul>
<h3 id="私有方法"><a href="#私有方法" class="headerlink" title="私有方法"></a>私有方法</h3><ul>
<li>void CreateVerificationText(int length);//随机生成验证码字符串</li>
<li>void CreateImage();//生成验证码图片</li>
<li>Color RandColor();//生成随机颜色</li>
<li>Point RandPoint();//生成随机点</li>
</ul>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SecurityCode Code=<span class="keyword">new</span> SecurityCode(<span class="number">4</span>);</span><br><span class="line">code.UpdateVerifyCode();</span><br><span class="line">picturebox.Image=code.getImage();</span><br></pre></td></tr></table></figure>
<h2 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h2><p><img src="/images/securitycode.jpg" alt="验证码"></p>
<h2 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">SecurityCode</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">private</span> Random rand = <span class="keyword">new</span> Random();<span class="comment">//生成随机数</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">string</span> VerificationText = <span class="keyword">string</span>.Empty;<span class="comment">//验证码字符串</span></span><br><span class="line">        <span class="keyword">private</span> Bitmap map;<span class="comment">//验证码的位图</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> length;<span class="comment">//验证码的字符个数</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> width;<span class="comment">//验证码图片的宽度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> height;<span class="comment">//验证码图片的高度</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SecurityCode</span>(<span class="params"><span class="keyword">int</span> length, <span class="keyword">int</span> width, <span class="keyword">int</span> height</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.length = length;</span><br><span class="line">            <span class="keyword">this</span>.width = width;</span><br><span class="line">            <span class="keyword">this</span>.height = height;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SecurityCode</span>(<span class="params"><span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.length = length;</span><br><span class="line">            <span class="keyword">this</span>.width = (length + <span class="number">1</span>) * <span class="number">25</span>;</span><br><span class="line">            <span class="keyword">this</span>.height = <span class="number">40</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//随机生成验证码字符串</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateVerificationText</span>(<span class="params"><span class="keyword">int</span> length</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            VerificationText = <span class="keyword">string</span>.Empty;</span><br><span class="line">            <span class="keyword">string</span> dictionary = <span class="string">"ABCDEFGHIJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789"</span>;<span class="comment">//去除O,o,0 ,l,1</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> index = rand.Next(<span class="number">0</span>, dictionary.Length);</span><br><span class="line">                VerificationText += dictionary[index].ToString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//刷新验证码</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UpdateVerifyCode</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            CreateVerificationText(length);</span><br><span class="line">            CreateImage();</span><br><span class="line">            <span class="comment">//Console.WriteLine(MD5Encrypt(VerificationText));//Only for test</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//生成验证码图片</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateImage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            map = <span class="keyword">new</span> Bitmap(width, height);</span><br><span class="line">            Graphics g = Graphics.FromImage(map);</span><br><span class="line">            Pen pen = <span class="keyword">new</span> Pen(Color.Black);</span><br><span class="line">            <span class="keyword">string</span>[] font = &#123; <span class="string">"Verdana"</span>, <span class="string">"Microsoft Sans Serif"</span>, <span class="string">"Consolas"</span>, <span class="string">"Arial"</span>, <span class="string">"宋体"</span> &#125;;</span><br><span class="line">            Font f = <span class="keyword">new</span> Font(<span class="string">"Arial"</span>, <span class="number">20</span>, FontStyle.Bold);</span><br><span class="line">            g.Clear(Color.White);</span><br><span class="line">            SolidBrush brush = <span class="keyword">new</span> SolidBrush(Color.White);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//绘制干扰线条</span></span><br><span class="line">            pen.Width = <span class="number">0.1F</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pen.Color = RandColor();</span><br><span class="line">                g.DrawLine(pen, RandPoint(), RandPoint());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//绘制干扰点</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">80</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Point p = RandPoint();</span><br><span class="line">                map.SetPixel(p.X, p.Y, RandColor());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//绘制字符串</span></span><br><span class="line">            SizeF  StringSizeF = g.MeasureString(VerificationText, f);</span><br><span class="line">            PointF StartPoint = <span class="keyword">new</span> Point(<span class="number">0</span>, (height - (<span class="keyword">int</span>)StringSizeF.Height) / <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                brush.Color = RandColor();</span><br><span class="line">                <span class="keyword">int</span> index = rand.Next(<span class="number">5</span>);</span><br><span class="line">                f = <span class="keyword">new</span> Font(font[index], <span class="number">20</span>, FontStyle.Bold);</span><br><span class="line">                StartPoint.X += <span class="number">5</span>;</span><br><span class="line">                g.DrawString(VerificationText[i].ToString(), f, brush, StartPoint);</span><br><span class="line">                SizeF CharSizeF = g.MeasureString(VerificationText[i].ToString(), f);</span><br><span class="line">                StartPoint.X += CharSizeF.Width;</span><br><span class="line">            &#125;</span><br><span class="line">            g.Dispose();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//生成随机颜色</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Color <span class="title">RandColor</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Color c = Color.FromArgb(rand.Next(<span class="number">1</span>, <span class="number">256</span>), rand.Next(<span class="number">1</span>, <span class="number">255</span>), rand.Next(<span class="number">1</span>, <span class="number">255</span>));</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//生成随机点</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Point <span class="title">RandPoint</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">int</span> x = rand.Next(<span class="number">0</span>, map.Width);</span><br><span class="line">            <span class="keyword">int</span> y = rand.Next(<span class="number">0</span>, map.Height);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Point(x, y);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回验证码图片</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Bitmap <span class="title">getImage</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回经MD5加密过的验证码字符串</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">MD5Encrypt</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Tool.MD5Encrypt(VerificationText);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回校验结果</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">Check</span>(<span class="params"><span class="keyword">string</span> text</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> text.ToUpper().Equals(VerificationText.ToUpper());<span class="comment">//不区分大小写</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/647653334.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/647653334.html" class="post-title-link" itemprop="url">银行家算法(使用DFS找出所有安全序列)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-06-02 12:41:13" itemprop="dateCreated datePublished" datetime="2018-06-02T12:41:13+08:00">2018-06-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/操作系统/" itemprop="url" rel="index">
                    <span itemprop="name">操作系统</span>
                  </a>
                </span>
            </span>

          
            <span id="/647653334.html" class="post-meta-item leancloud_visitors" data-flag-title="银行家算法(使用DFS找出所有安全序列)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><h3 id="银行家算法"><a href="#银行家算法" class="headerlink" title="银行家算法"></a>银行家算法</h3><p>银行家算法是一种最有代表性的避免死锁的算法。在避免死锁方法中允许进程动态地申请资源，但系统在进行资源分配之前，应先计算此次分配资源的安全性，若分配不会导致系统进入不安全状态，则分配，否则等待。为实现银行家算法，系统必须设置若干数据结构。</p>
<h3 id="安全状态"><a href="#安全状态" class="headerlink" title="安全状态"></a>安全状态</h3><ul>
<li>系统能按某种进程推进顺序{P<sub>1</sub>，…，P<sub>n</sub>}为每个进程P<sub>i</sub>分配其所需资源，直至满足每个进程对资源的最大需求，使每个进程都可顺利地完成。</li>
<li>此时称{P<sub>1</sub>，…，P<sub>n</sub>}为安全序列。如果系统无法找到这样一个安全序列，则称系统处于不安全状态。</li>
<li>并非所有不安全状态都必然会转为死锁状态，但当系统进入不安全状态后，就有可能进入死锁状态。反之，只要系统处于安全状态，系统便不会进入死锁状态。</li>
<li>因此，避免死锁的实质在于，系统在进行资源分配时，应用系统不进入不安全状态。</li>
</ul>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ol>
<li>可利用资源向量Available<br>是个含有m个元素的数组，其中的每一个元素代表一类可利用的资源数目。如果Available[j]=K，则表示系统中现有Rj类资源K个。</li>
<li>最大需求矩阵Max<br>这是一个n×m的矩阵，它定义了系统中n个进程中的每一个进程对m类资源的最大需求。如果Max[i,j]=K，则表示进程i需要R<sub>j</sub>类资源的最大数目为K。</li>
<li>分配矩阵Allocation<br>这也是一个n×m的矩阵，它定义了系统中每一类资源当前已分配给每一进程的资源数。如果Allocation[i,j]=K，则表示进程i当前已分得R<sub>j</sub>类资源的数目为K。</li>
<li>需求矩阵Need。<br>这也是一个n×m的矩阵，用以表示每一个进程尚需的各类资源数。如果Need[i,j]=K，则表示进程i还需要R<sub>j</sub>类资源K个，方能完成其任务。<br>Need[i,j]=Max[i,j]-Allocation[i,j]</li>
</ol>
<h2 id="银行家算法-1"><a href="#银行家算法-1" class="headerlink" title="银行家算法"></a>银行家算法</h2><p>设Request<sub>i</sub>是进程P<sub>i</sub>的请求向量，如果Request<sub>i</sub>[j]=K,表示进程P<sub>i</sub>需要K个R<sub>j</sub>类型。当P<sub>i</sub>发出资源请求后，系统按下输步骤进行检查:</p>
<ol>
<li>如果Request<sub>i</sub>[j] &lt;= Need[i][j],便转向步骤2；否则认为出错，因为它所需要的资源数已超过它所宣布的最大值</li>
<li>如果Request<sub>i</sub>[j] &lt;= Available[i][j]，便转向步骤3；否则表示尚无足够资源，P<sub>i</sub>需等待  </li>
<li>系统试探着把资源分配给进程P<sub>i</sub>,并修改下面数据结构中的数值:<ul>
<li>Available[j] -= Request<sub>i</sub>[j]</li>
<li>Allocation[i][j] += Request<sub>i</sub>[j]</li>
<li>Need[i][j] -= Request<sub>i</sub>[j]</li>
</ul>
</li>
<li>系统执行安全性算法，检查此次资源分配后系统是否处于安全状态.若安全，正式将资源分配给进程P<sub>i</sub>，以完成本次分配；否则，讲将本次的试探分配作废,恢复原来的资源分配状态，让进程P<sub>i</sub>等待</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_bank</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//按照银行家算法检查资源请求</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Request[j] &gt; Need[i][j] || Request[j] &gt; Available[j])</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    update(i, Request);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="尝试分配资源-恢复原来的资源分配状态"><a href="#尝试分配资源-恢复原来的资源分配状态" class="headerlink" title="尝试分配资源/恢复原来的资源分配状态"></a>尝试分配资源/恢复原来的资源分配状态</h2><h3 id="尝试分配资源"><a href="#尝试分配资源" class="headerlink" title="尝试分配资源"></a>尝试分配资源</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//更新数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        Available[j] -= Request[j];</span><br><span class="line">        Allocation[i][j] += Request[j];</span><br><span class="line">        Need[i][j] -= Request[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="恢复原来的资源分配状态"><a href="#恢复原来的资源分配状态" class="headerlink" title="恢复原来的资源分配状态"></a>恢复原来的资源分配状态</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recovery</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span><span class="comment">//还原数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        Available[j] += Request[j];</span><br><span class="line">        Allocation[i][j] -= Request[j];</span><br><span class="line">        Need[i][j] += Request[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="安全性算法"><a href="#安全性算法" class="headerlink" title="安全性算法"></a>安全性算法</h2><ol>
<li>设置两个工作向量:<br>① 工作向量WORK，它表示系统可提供给进程继续运行所需的各类资源数目，它含有m个元素，在执行安全算法开始时，WORK:=Available<br>② Finish:它表示系统是否有足够的资源分配给进程，使之运行完成。初始Finish[i]: = false；当有足够资源分配给进程时，再令Finish[i]：=true。 </li>
<li>从进程集合中找出一个满足下列条件的进程：<br>① Finish[i] = false<br>② Need[i][j] &lt;= work[j]<br>若找到，执行3,否则，执行步骤4</li>
<li>当进程p<sub>i</sub>获得资源后，可顺利执行，直至完成，并释放出分配给它的资源，故应执行:</li>
</ol>
<ul>
<li>Finish[i] = true </li>
<li>WORK[j] += Allocation[i][j]</li>
<li>go to step 2</li>
</ul>
<ol start="4">
<li>如果所有进程的Finish[i] = true，则表示系统处于安全性状态，否则，系统处于不安全状态。</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_safe</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//检查系统安全性</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> Work[MaxNumber];</span><br><span class="line">    <span class="keyword">bool</span> Finished[MaxNumber];</span><br><span class="line">    <span class="built_in">memset</span>(Finished, <span class="literal">false</span>, <span class="keyword">sizeof</span>(Finished));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        Work[i] = Available[i];</span><br><span class="line">    sta = UnSafe;</span><br><span class="line">    Dfs(<span class="number">0</span>, Work, Finished);</span><br><span class="line">    <span class="keyword">if</span>(sta==UnSafe)</span><br><span class="line">        recovery(i, Request);<span class="comment">//还原数据</span></span><br><span class="line">    <span class="keyword">return</span> sta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>复杂度分析:安全性检查算法，有两种for循环，最内层for循环每次继续向下一层搜索，故时间复杂度为O((n * m)^ n)</p>
<h2 id="利用Dfs找出所有安全序列"><a href="#利用Dfs找出所有安全序列" class="headerlink" title="利用Dfs找出所有安全序列"></a>利用Dfs找出所有安全序列</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Work[], <span class="keyword">bool</span> Finished[])</span><span class="comment">//深度优先搜索,找到所有的安全序列</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(i == n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(Finished[j] == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sta = Safe;</span><br><span class="line">        SafeOrder.push_back(temp);</span><br><span class="line">        <span class="comment">//temp.clear();</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Finished[j] == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> t = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(Need[j][k] &gt; Work[k])</span><br><span class="line">                &#123;</span><br><span class="line">                    t = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(t == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">                    Work[k] += Allocation[j][k];</span><br><span class="line">                Finished[j] = <span class="literal">true</span>;</span><br><span class="line">                temp.push_back(j);</span><br><span class="line">                Dfs(i + <span class="number">1</span>, Work, Finished);</span><br><span class="line">                temp.pop_back();       <span class="comment">//回溯,将第i个进程所做的改变恢复</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Work[k] -= Allocation[j][k];</span><br><span class="line">                &#125;</span><br><span class="line">                Finished[j] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h2><div class="note default no-icon"><p>3<br>A 3<br>B 3<br>C 2<br>5<br>7 5 3<br>3 2 2<br>9 0 2<br>2 2 2<br>4 3 3<br>0 1 0<br>2 0 0<br>3 0 2<br>2 1 1<br>0 0 2<br>2<br>1<br>1<br>0<br>2<br></p></div>

<h2 id="实验截图"><a href="#实验截图" class="headerlink" title="实验截图"></a>实验截图</h2><p><img src="/images/Banker&#39;s Algorithm1.jpg" alt="合理且安全的资源请求"></p>
<center>合理且安全的资源请求</center><br><img src="/images/Banker&#39;s Algorithm2.jpg" alt="不合理的资源请求"><br><center>不合理的资源请求</center><br><img src="/images/Banker&#39;s Algorithm3.jpg" alt="会导致系统处于不安全状态的资源请求"><br><center>会导致系统处于不安全状态的资源请求</center>

<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Problem:银行家算法</span></span><br><span class="line"><span class="comment">Author:QiZhao</span></span><br><span class="line"><span class="comment">Data:2018-05-31</span></span><br><span class="line"><span class="comment">Description:预防进程死锁的银行家算法</span></span><br><span class="line"><span class="comment">Copyright  2018 QiZhao. All rights reserved.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;//提供vector</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;//提供memset函数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;//提供fflush函数</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;//提供exit函数</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> status &#123;Safe, UnSafe&#125;;<span class="comment">//安全性检查的结果</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> MaxNumber = <span class="number">100</span>;<span class="comment">//进程数量的最大值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> Available[MaxNumber];<span class="comment">//每种资源的可用数量</span></span><br><span class="line"><span class="keyword">int</span> Max[MaxNumber][MaxNumber];<span class="comment">//n*m的矩阵,表示每个进程所需的最大资源量</span></span><br><span class="line"><span class="built_in">string</span> name[MaxNumber];<span class="comment">//n个进程的进程名</span></span><br><span class="line"><span class="keyword">int</span> Allocation[MaxNumber][MaxNumber];<span class="comment">//n*m的矩阵,表示每个进程每种资源已经分配的量</span></span><br><span class="line"><span class="keyword">int</span> Need[MaxNumber][MaxNumber];<span class="comment">//n*m的矩阵,表示每个进程还需的每种资源量</span></span><br><span class="line"><span class="keyword">int</span> Request[MaxNumber];<span class="comment">//所请求的每种资源的资源量</span></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &gt; SafeOrder;<span class="comment">//存储所有的安全序列</span></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; temp;<span class="comment">//存储一个临时安全序列</span></span><br><span class="line"><span class="keyword">int</span> n, m;<span class="comment">//进程数，资源种类数</span></span><br><span class="line"></span><br><span class="line">status sta = UnSafe;<span class="comment">//安全性检查的结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//函数声明</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recovery</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_bank</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_safe</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">choose</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dfs</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> Wordk[],<span class="keyword">bool</span> Finished[])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数实现</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">input</span><span class="params">()</span><span class="comment">//读入数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入系统资源的种类数:"</span>;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; m;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请依次输入"</span> &lt;&lt; m &lt;&lt; <span class="string">"种系统资源的名称与数量:"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; name[i] &gt;&gt; Available[i];</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入进程的数量:"</span>;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; n;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入各个进程的最大需求量&lt;"</span> &lt;&lt; n &lt;&lt; <span class="string">"*"</span> &lt;&lt; m &lt;&lt; <span class="string">"矩阵&gt;[MAX]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; Max[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入各进程已申请的资量&lt;"</span> &lt;&lt; n &lt;&lt; <span class="string">"*"</span> &lt;&lt; m &lt;&lt; <span class="string">"矩阵&gt;[Allocation]"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">            <span class="built_in">cin</span> &gt;&gt; Allocation[i][j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span><span class="comment">//计算Need</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            Need[i][j] = Max[i][j] - Allocation[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span><span class="comment">//显示资源使用情况</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">" Max\tAllocation\tNeed\tAvaliable"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(j==<span class="number">3</span>)</span><br><span class="line">            <span class="built_in">cout</span>&lt;&lt;<span class="string">" "</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; name[i] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">            <span class="keyword">if</span>(j == <span class="number">1</span>)</span><br><span class="line">                <span class="built_in">cout</span> &lt;&lt; <span class="string">"  "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; Max[i][j] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; Allocation[i][j] &lt;&lt; <span class="string">"   "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t"</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; Need[i][j] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t "</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; Available[j] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//更新数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        Available[j] -= Request[j];</span><br><span class="line">        Allocation[i][j] += Request[j];</span><br><span class="line">        Need[i][j] -= Request[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recovery</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span><span class="comment">//还原数据</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        Available[j] += Request[j];</span><br><span class="line">        Allocation[i][j] -= Request[j];</span><br><span class="line">        Need[i][j] += Request[j];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">check_bank</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//按照银行家算法检查资源请求</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Request[j] &gt; Need[i][j] || Request[j] &gt; Available[j])</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    update(i, Request);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Dfs</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Work[], <span class="keyword">bool</span> Finished[])</span><span class="comment">//深度优先搜索,找到所有的安全序列</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(i == n)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(Finished[j] == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sta = Safe;</span><br><span class="line">        SafeOrder.push_back(temp);</span><br><span class="line">        <span class="comment">//temp.clear();</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(Finished[j] == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> t = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(Need[j][k] &gt; Work[k])</span><br><span class="line">                &#123;</span><br><span class="line">                    t = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(t == <span class="literal">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">                    Work[k] += Allocation[j][k];</span><br><span class="line">                Finished[j] = <span class="literal">true</span>;</span><br><span class="line">                temp.push_back(j);</span><br><span class="line">                Dfs(i + <span class="number">1</span>, Work, Finished);</span><br><span class="line">                temp.pop_back();       <span class="comment">//回溯,将第i个进程所做的改变恢复</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; m; k++)</span><br><span class="line">                &#123;</span><br><span class="line">                    Work[k] -= Allocation[j][k];</span><br><span class="line">                &#125;</span><br><span class="line">                Finished[j] = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">check_safe</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> Request[])</span> <span class="comment">//检查系统安全性</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> Work[MaxNumber];</span><br><span class="line">    <span class="keyword">bool</span> Finished[MaxNumber];</span><br><span class="line">    <span class="built_in">memset</span>(Finished, <span class="literal">false</span>, <span class="keyword">sizeof</span>(Finished));</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i++)</span><br><span class="line">        Work[i] = Available[i];</span><br><span class="line">    sta = UnSafe;</span><br><span class="line">    Dfs(<span class="number">0</span>, Work, Finished);</span><br><span class="line">    <span class="keyword">if</span>(sta==UnSafe)</span><br><span class="line">        recovery(i, Request);<span class="comment">//还原数据</span></span><br><span class="line">    <span class="keyword">return</span> sta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">request</span><span class="params">()</span><span class="comment">//某个进程申请资源</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">memset</span>(Request, <span class="number">0</span>, <span class="keyword">sizeof</span>(Request));</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入要请求分配资源的进程号&lt;0~"</span> &lt;&lt; n &lt;&lt; <span class="string">"&gt;:"</span>;</span><br><span class="line">    <span class="built_in">cin</span> &gt;&gt; i;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"请输入进程"</span> &lt;&lt; i &lt;&lt; <span class="string">"申请的资源数目"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; m; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; name[j] &lt;&lt; <span class="string">":"</span>;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; Request[j];</span><br><span class="line">    &#125;</span><br><span class="line">    SafeOrder.clear();</span><br><span class="line">    <span class="keyword">if</span>(check_bank(i, Request) == <span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(check_safe(i, Request) == Safe)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"系统是安全的!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"安全序列有:"</span>&lt;&lt;SafeOrder.size()&lt;&lt;<span class="string">"种"</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; SafeOrder.size(); j++)<span class="comment">//输出所有的安全序列</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; SafeOrder[j].size(); k++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">cout</span> &lt;&lt; <span class="string">"P"</span> &lt;&lt; SafeOrder[j][k];</span><br><span class="line">                    <span class="keyword">if</span>(k != SafeOrder[j].size() - <span class="number">1</span>)</span><br><span class="line">                        <span class="built_in">cout</span> &lt;&lt; <span class="string">"-&gt;"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(SafeOrder[j].size()!=<span class="number">0</span>)</span><br><span class="line">                <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"系统不安全,恢复原来状态!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"资源请求不合理!"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">choose</span><span class="params">()</span><span class="comment">//选择菜单</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> i = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        fflush(<span class="built_in">stdin</span>);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">"请选择你要进行的操作"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="built_in">cin</span> &gt;&gt; i;</span><br><span class="line">        <span class="keyword">switch</span>(i)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'0'</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'2'</span>:</span><br><span class="line">            request();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'1'</span>:</span><br><span class="line">            show();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; <span class="string">"输入有误,请重新输入"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        menu();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span><span class="comment">//显示菜单</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"****************银行家算法演示***************"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t1:显示各个矩阵的内容"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t2:进程请求系统分配资源"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"\t\t0:退出程序"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">"*********************************************"</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//freopen("in.txt", "r", stdin);</span></span><br><span class="line">    <span class="comment">//freopen("out.txt", "w", stdout);</span></span><br><span class="line">    input();</span><br><span class="line">    init();</span><br><span class="line">    menu();</span><br><span class="line">    choose();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://blog.csdn.net/qq_27008079/article/details/53946253" target="_blank" rel="noopener">银行家算法实现——找出所有安全序列</a><br><a href="https://baike.baidu.com/item/%E9%93%B6%E8%A1%8C%E5%AE%B6%E7%AE%97%E6%B3%95/1679781?fr=aladdin" target="_blank" rel="noopener">百度百科_银行家算法</a><br><a href="https://baike.baidu.com/item/计算机操作系统（第四版）/19925494" target="_blank" rel="noopener">《计算机操作系统（第四版）》</a>，汤小丹，西安电子科技大学出版社，2014.5</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/45013.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/45013.html" class="post-title-link" itemprop="url">用Python实现校园通知更新提醒</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-21 21:26:00" itemprop="dateCreated datePublished" datetime="2018-04-21T21:26:00+08:00">2018-04-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          
            <span id="/45013.html" class="post-meta-item leancloud_visitors" data-flag-title="用Python实现校园通知更新提醒" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个项目实已经在一个月前已经完成了，一直都想写一篇博客来总结这个过程中遇到的一些问题。但最近一个月来都比较忙，所以一直拖到了现在。<br>首先说说起因吧，我没事的时候，总喜欢依次点开学校主页、教务处、图书馆以及学院的网站，看看有没有什么新通知，虽然大多与我无关。恰逢最近正在学Python，经常听到别人说用Python写爬虫很简单，但自己尚未接触过爬虫。于是抱着试一试的心态看了几篇关于Python爬虫的博客，发现实现起来的确很简单。于是，便一边看着官方的文档说明，一边看着别人的博客，终于完成了自己的第一次爬虫。</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>使用<code>urllib.request</code>库获取到目标url(各个网站的’更多通知’页)的源代码，然后利用Python的<code>re</code>库进行正则匹配，提取到通知相关信息后，与文件中存取的上一次爬取到的信息进行对比。<br>若检测到有新的通知，则利用<code>twilio</code>库向指定手机号码发送SMS，利用<code>smtplib</code>库向指定邮箱发送提醒信息。<br>此外，还具有发送日志以及异常日志的功能。<br>目前仅支持本校的通知提醒，后续会逐步提高项目的通用性。</p>
<h2 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h2><p>Github地址:<a href="https://github.com/ZhaoQi99/School_Notice" target="_blank" rel="noopener">School_Notice</a></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><ul>
<li>安装twilio库:<code>pip install twilio</code></li>
<li>注册twilio账号:<a href="https://www.twilio.com" target="_blank" rel="noopener">Twilio</a></li>
<li>验证手机号:用来接收短信提醒的号码必须在twilio上进行验证</li>
</ul>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><h3 id="邮件发送"><a href="#邮件发送" class="headerlink" title="邮件发送"></a>邮件发送</h3><ul>
<li>若用名为msg的变量来保存邮件文本，则<code>msg[&#39;From&#39;]</code>以及<code>msg[&#39;To&#39;]</code>必须为实际的发件人地址，否则可能会出现异常:<code>SMTPDataError(code, resp)</code>.如必须写作:<code>msg[&#39;From&#39;] = &#39;xxxxx@qq.com&#39;</code>.我是使用的QQ邮箱来发邮件，至于其他邮箱需不需要这样写还不清楚。 </li>
<li>原本想用一个for循环来实现多人发送，后来发现smtplib库的sendmail方法支持多人发送，但参数应为一个list，故可用<code>str.split(&#39;,&#39;)</code>将字符串转为list。</li>
<li>我使用的是Windows下的Python，若计算机名为中文，则有可能会导致出现异常，可通过右击此电脑-&gt;属性，修改计算机名。</li>
<li>程序代码中使用的邮箱密码不是QQ密码，应在邮箱设置-&gt;账户-&gt;SMTP服务处，获取授权码。</li>
</ul>
<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><ul>
<li>有时候会接收不到Twilio发送的短信，给10086打电话也没问出个所以然，可能是因为短信中有敏感词(如:学校名)，修改短信内容后就可以了</li>
<li><p>对上述几个网站的源码使用<code>re.findall</code>后返回的列表中的每个元组中的元素的顺序均为时间、标题、链接，但对学生处网站的源码正则匹配后的元素顺序并不是按照上述顺序的。所以应单独进行调整，但直接修改一个元组中的元素，会出现异常:<code>error:tuple&#39; object does not support item assignment</code>。解决方法是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(subject_EN == <span class="string">'snnu_xsc'</span>):</span><br><span class="line">	new_data = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> data:</span><br><span class="line">		temp = (item[<span class="number">1</span>], item[<span class="number">2</span>], item[<span class="number">0</span>])</span><br><span class="line">        new_data.append(temp)</span><br><span class="line">    data = new_data</span><br></pre></td></tr></table></figure>
</li>
<li><p>Python3中的print函数是自动换行的，若不需要自动换行，则可写作:<code>print(str,end=&#39;&#39;)</code></p>
</li>
<li>不同网站的编码格式可能不同，应按照各自的编码方式进行解码。若均采用<code>utf-8</code>的方式，则可能会出现各种编码问题，如:<br><div class="note danger"><p>UnicodeDecodeError: ‘utf-8’ codec can’t decode byte 0xc9 in position 167<br></p></div><br>解决方法是:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> find1 == <span class="number">-1</span> &amp; find2 == <span class="number">-1</span>:</span><br><span class="line">	Coding = <span class="string">'utf-8'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="comment"># 教务处网页源码编码格式为为gbk</span></span><br><span class="line">	<span class="comment"># 学生处网页源码编码格式为gb2312</span></span><br><span class="line">	Coding = <span class="string">'gbk'</span></span><br><span class="line">data = response.read().decode(Coding)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Python程序打包为exe-Pyinstaller"><a href="#Python程序打包为exe-Pyinstaller" class="headerlink" title="Python程序打包为exe(Pyinstaller)"></a>Python程序打包为exe(Pyinstaller)</h2><h3 id="安装及使用"><a href="#安装及使用" class="headerlink" title="安装及使用"></a>安装及使用</h3><ol>
<li>使用<code>pip install pywin32</code>安装pywin32</li>
<li>使用<code>pip install PyInstaller</code>安装Pyinstaller</li>
<li>使用<code>pyinstaller -F main.py</code>即可将Python程序打包为exe程序</li>
</ol>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul>
<li>打包之前应将用到的第三方库(此项目仅用到Twilio)复制到与要打包的py文件同一目录下。</li>
<li>可使用<code>pyinstaller -F -i logo.ico main.py</code>,为生成的exe程序添加图标</li>
<li>使用的ico文件像素不能过小，否则有可能出现:打包后的程序图标只有在资源管理器中设置为以小图标查看的情况下才显示的是自己的图标，其他情况仍未默认图标</li>
</ul>
<h2 id="使用截图"><a href="#使用截图" class="headerlink" title="使用截图"></a>使用截图</h2><p><img src="/images/Screenshot_2018-03-13-09-32-23-47.jpg" alt><br><img src="/images/send_email.jpg" alt><br><img src="/images/20180426015859.jpg" alt></p>
<h2 id="参考博客"><a href="#参考博客" class="headerlink" title="参考博客"></a>参考博客</h2><ol>
<li><a href="https://blog.csdn.net/hanyou11/article/details/50756800" target="_blank" rel="noopener">应用python对校园通知的更新进行推送</a></li>
<li><a href="https://blog.csdn.net/zyc121561/article/details/78169168" target="_blank" rel="noopener">使用python发短信给自己的手机</a></li>
<li><a href="https://www.cnblogs.com/gopythoner/p/6337543.html" target="_blank" rel="noopener">Python打包方法——Pyinstaller</a></li>
</ol>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zhaoqi.vip/18543.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhao Qi">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温柔小猪">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/18543.html" class="post-title-link" itemprop="url">Github pages个人域名添加SSL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-10 11:08:11" itemprop="dateCreated datePublished" datetime="2018-04-10T11:08:11+08:00">2018-04-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hexo/" itemprop="url" rel="index">
                    <span itemprop="name">Hexo</span>
                  </a>
                </span>
            </span>

          
            <span id="/18543.html" class="post-meta-item leancloud_visitors" data-flag-title="Github pages个人域名添加SSL" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>0</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>寒假的时候用Hexo+Github pages搭建了属于自己的博客，前不久才绑定了个人域名。作为一名有强迫症的程序猿，肯定还要给自己加一个绿色的小锁头。<br>在网上看别人的博客，大部分是用的<a href="https://www.cloudflare.com/" target="_blank" rel="noopener">CloudFlare</a>提供的免费https服务，也有采用的阿里云提供的一年免费证书，我选择的是后者。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>个人域名:<a href="https://zhaoqi99.github.io/" target="_blank" rel="noopener">https://赵旗.top/</a></li>
<li>Github pages</li>
<li>阿里云购买的SSL证书</li>
</ul>
<h2 id="添加SSL证书"><a href="#添加SSL证书" class="headerlink" title="添加SSL证书"></a>添加SSL证书</h2><ol>
<li>进入阿里云控制台，依次点击安全(云盾)-&gt;CA证书服务，然后点击右上角的购买证书。<br><img src="/images/20180410134416.jpg" alt></li>
<li>依次选择品牌为<code>Symantec</code>，保护类型为<code>一个域名</code>，证书类型此时会多出一个选项<code>免费型DV SSL</code>点击选择,然后点击立即购买，支付0.00元。<br><img src="/images/20180410134752.jpg" alt><br><img src="/images/20180410113516.jpg" alt><div class="note danger no-icon"><p>注意:免费的SSL证书有效期只有一年，过期之后就需要重新申请了。<br></p></div></li>
<li>支付成功后，点击进入证书控制台，然后点击<code>补全</code>，填写相关信息，提交申请。<br><img src="/images/20180410140626.jpg" alt><br><img src="/images/20180410113758.jpg" alt><div class="note warning"><p><br>域名验证类型选项记得勾选:证书绑定的域名在【阿里云的云解析】产品中，授权系统自动添加一条记录以完成域名授权验证。<br></p></div></li>
<li>等待20分钟左右，即可收到签发成功的通知了，也可以在证书控制台中实时看到审核进度。</li>
<li>在浏览器中输入https://域名/ ，可以看到地址栏前面有一个小绿锁，很惊喜有没有~<br><img src="/images/20180410140910.jpg" alt></li>
</ol>
<h2 id="http强制跳转https"><a href="#http强制跳转https" class="headerlink" title="http强制跳转https"></a>http强制跳转https</h2><p>按照上述步骤添加了SSL证书后，发现如果在地址栏中输入的是https://域名/ 就会有绿锁头，如果输入的是http://域名/ ，则还是http,并不会自动跳转至https。怎样让访客点击http://域名/ 时能强制跳转到https呢？<br>在Google上看了好多的博客都没能找到解决方案，突然发现Github上有一个<code>Enforce HTTPS</code>选项，抱着试一试的心态，最后竟然成功了。</p>
<ol>
<li>登录Github，进入自己的Github.io项目中，点击<code>Setting</code>，往下拉，可以看到有个选项叫<code>Enforce HTTPS</code>,点击勾选。<br><img src="/images/20180410115944.jpg" alt></li>
<li>打开浏览器，在地址中输入自己的http://域名/ ，已经可以自动跳转到https下了，大功告成。</li>
</ol>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhao Qi</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">26</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ZhaoQi99" title="GitHub → https://github.com/ZhaoQi99" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:956361916@qq.com" title="E-Mail → mailto:956361916@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.csdn.net/zaq0123" title="Csdn → http://blog.csdn.net/zaq0123" rel="noopener" target="_blank"><i class="fa fa-fw fa-crosshairs"></i>Csdn</a>
      </span>
      <span class="links-of-author-item">
        <a href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=956361916&website=www.oicqzone.com" title="QQ → tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=956361916&website=www.oicqzone.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-qq"></i>QQ</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Qi</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">104k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">2:54</span>
</div>
  <div class="addthis_inline_share_toolbox">
    <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a73dc9a89a291e2" async="async"></script>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>






  <script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.getAttribute('data-flag-title');

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=NVtkdirQcac4WxHwW9zBvmju-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method: method,
          headers: {
            'X-LC-Id': 'NVtkdirQcac4WxHwW9zBvmju-gzGzoHsz',
            'X-LC-Key': 'bLIaRQ4SzyDQ75lU7LO2Bzyb',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>




  <script src="/js/local-search.js"></script>








<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '500px'
      });
    });
  }, window.PDFObject);
}
</script>




  

  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout: 3000,
        priority: true,
        ignores: [uri => uri.includes('#'),uri => uri == 'https://zhaoqi.vip/',]
      });
      });
  </script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body>
</html>
