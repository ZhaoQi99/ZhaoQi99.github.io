THREE.SpriteCanvasMaterial=function(e){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.clone=function(){var e=new THREE.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},THREE.CanvasRenderer=function(e){console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var t,i,n,o,r,a,s,l,c,p,E,f,d,h,m,v,x,y,R,u=this,T=new THREE.Projector,g=void 0!==e.canvas?e.canvas:document.createElement("canvas"),S=g.width,w=g.height,H=Math.floor(S/2),C=Math.floor(w/2),M=0,b=0,L=S,B=w,P=1,V=g.getContext("2d",{alpha:!0===e.alpha}),W=new THREE.Color(0),z=!0===e.alpha?0:1,j=1,k=0,D=null,F=null,N=null,O=null,A=null,I=[],G=(new THREE.RenderableVertex,new THREE.RenderableVertex,new THREE.Color),U=(new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color,new THREE.Color),q=new THREE.Color,J=new THREE.Color,K={},Q=new THREE.Box2,X=new THREE.Box2,Y=new THREE.Box2,Z=new THREE.Color,$=new THREE.Color,_=new THREE.Color,ee=new THREE.Vector3,te=new THREE.Vector3,ie=new THREE.Vector3,ne=new THREE.Matrix3;function oe(e,t,i){fe(i.opacity),de(i.blending);var n=t.scale.x*H,o=t.scale.y*C,r=.5*Math.sqrt(n*n+o*o);if(Y.min.set(e.x-r,e.y-r),Y.max.set(e.x+r,e.y+r),i instanceof THREE.SpriteMaterial){var a=i.map;if(null!==a){var s=K[a.id];if(void 0!==s&&s.version===a.version||(s=ce(a),K[a.id]=s),void 0!==s.canvas){ye(s.canvas);var l=a.image,c=l.width*a.offset.x,p=l.height*a.offset.y,E=l.width*a.repeat.x,f=l.height*a.repeat.y,d=n/E,h=o/f;V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.translate(-n/2,-o/2),V.scale(d,h),V.translate(-c,-p),V.fillRect(c,p,E,f),V.restore()}}else ye(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(n,-o),V.fillRect(-.5,-.5,1,1),V.restore()}else i instanceof THREE.SpriteCanvasMaterial&&(xe(i.color.getStyle()),ye(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(n,o),i.program(V),V.restore())}function re(e,t,i,n){if(fe(n.opacity),de(n.blending),V.beginPath(),V.moveTo(e.positionScreen.x,e.positionScreen.y),V.lineTo(t.positionScreen.x,t.positionScreen.y),n instanceof THREE.LineBasicMaterial){if(he(n.linewidth),me(n.linecap),ve(n.linejoin),n.vertexColors!==THREE.VertexColors)xe(n.color.getStyle());else{var o=i.vertexColors[0].getStyle(),r=i.vertexColors[1].getStyle();if(o===r)xe(o);else{try{var a=V.createLinearGradient(e.positionScreen.x,e.positionScreen.y,t.positionScreen.x,t.positionScreen.y);a.addColorStop(0,o),a.addColorStop(1,r)}catch(s){a=o}xe(a)}}V.stroke(),Y.expandByScalar(2*n.linewidth)}else n instanceof THREE.LineDashedMaterial&&(he(n.linewidth),me(n.linecap),ve(n.linejoin),xe(n.color.getStyle()),Re([n.dashSize,n.gapSize]),V.stroke(),Y.expandByScalar(2*n.linewidth),Re([]))}function ae(e,t,i,o,r,a,T,g){var S,w,H,C,M,b;if(u.info.render.vertices+=3,u.info.render.faces++,fe(g.opacity),de(g.blending),s=e.positionScreen.x,l=e.positionScreen.y,c=t.positionScreen.x,p=t.positionScreen.y,E=i.positionScreen.x,f=i.positionScreen.y,S=s,w=l,H=c,C=p,M=E,b=f,V.beginPath(),V.moveTo(S,w),V.lineTo(H,C),V.lineTo(M,b),V.closePath(),(g instanceof THREE.MeshLambertMaterial||g instanceof THREE.MeshPhongMaterial)&&null===g.map)U.copy(g.color),q.copy(g.emissive),g.vertexColors===THREE.FaceColors&&U.multiply(T.color),G.copy(Z),te.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),function(e,t,i){for(var o=0,r=n.length;o<r;o++){var a=n[o];if(J.copy(a.color),a instanceof THREE.DirectionalLight){var s=ee.setFromMatrixPosition(a.matrixWorld).normalize();if((l=t.dot(s))<=0)continue;l*=a.intensity,i.add(J.multiplyScalar(l))}else if(a instanceof THREE.PointLight){var l;if(s=ee.setFromMatrixPosition(a.matrixWorld),(l=t.dot(ee.subVectors(s,e).normalize()))<=0)continue;if(0==(l*=0==a.distance?1:1-Math.min(e.distanceTo(s)/a.distance,1)))continue;l*=a.intensity,i.add(J.multiplyScalar(l))}}}(te,T.normalModel,G),G.multiply(U).add(q),!0===g.wireframe?se(G,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):le(G);else if(g instanceof THREE.MeshBasicMaterial||g instanceof THREE.MeshLambertMaterial||g instanceof THREE.MeshPhongMaterial){if(null!==g.map)g.map.mapping===THREE.UVMapping&&(d=T.uvs,pe(s,l,c,p,E,f,d[o].x,d[o].y,d[r].x,d[r].y,d[a].x,d[a].y,g.map));else null!==g.envMap?g.envMap.mapping===THREE.SphericalReflectionMapping&&(ie.copy(T.vertexNormalsModel[o]).applyMatrix3(ne),h=.5*ie.x+.5,m=.5*ie.y+.5,ie.copy(T.vertexNormalsModel[r]).applyMatrix3(ne),v=.5*ie.x+.5,x=.5*ie.y+.5,ie.copy(T.vertexNormalsModel[a]).applyMatrix3(ne),y=.5*ie.x+.5,R=.5*ie.y+.5,pe(s,l,c,p,E,f,h,m,v,x,y,R,g.envMap)):(G.copy(g.color),g.vertexColors===THREE.FaceColors&&G.multiply(T.color),!0===g.wireframe?se(G,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):le(G))}else g instanceof THREE.MeshNormalMaterial?(ie.copy(T.normalModel).applyMatrix3(ne),G.setRGB(ie.x,ie.y,ie.z).multiplyScalar(.5).addScalar(.5),!0===g.wireframe?se(G,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):le(G)):(G.setRGB(1,1,1),!0===g.wireframe?se(G,g.wireframeLinewidth,g.wireframeLinecap,g.wireframeLinejoin):le(G))}function se(e,t,i,n){he(t),me(i),ve(n),xe(e.getStyle()),V.stroke(),Y.expandByScalar(2*t)}function le(e){ye(e.getStyle()),V.fill()}function ce(e){if(0===e.version||e instanceof THREE.CompressedTexture||e instanceof THREE.DataTexture)return{canvas:void 0,version:e.version};var t=e.image;if(!1===t.complete)return{canvas:void 0,version:0};var i=e.wrapS===THREE.RepeatWrapping||e.wrapS===THREE.MirroredRepeatWrapping,n=e.wrapT===THREE.RepeatWrapping||e.wrapT===THREE.MirroredRepeatWrapping,o=e.wrapS===THREE.MirroredRepeatWrapping,r=e.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=t.width*(o?2:1),a.height=t.height*(r?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,t.height),s.drawImage(t,0,0),!0===o&&(s.setTransform(-1,0,0,-1,t.width,t.height),s.drawImage(t,-t.width,0)),!0===r&&(s.setTransform(1,0,0,1,0,0),s.drawImage(t,0,t.height)),!0===o&&!0===r&&(s.setTransform(-1,0,0,1,t.width,0),s.drawImage(t,-t.width,t.height));var l="no-repeat";!0===i&&!0===n?l="repeat":!0===i?l="repeat-x":!0===n&&(l="repeat-y");var c=V.createPattern(a,l);return e.onUpdate&&e.onUpdate(e),{canvas:c,version:e.version}}function pe(e,t,i,n,o,r,a,s,l,c,p,E,f){var d=K[f.id];if(void 0!==d&&d.version===f.version||(d=ce(f),K[f.id]=d),void 0===d.canvas)return ye("rgba( 0, 0, 0, 1)"),void V.fill();ye(d.canvas);var h,m,v,x,y,R,u,T,g=f.offset.x/f.repeat.x,S=f.offset.y/f.repeat.y,w=f.image.width*f.repeat.x,H=f.image.height*f.repeat.y;l=(l+g)*w,c=(c+S)*H,p=(p+g)*w,E=(E+S)*H,i-=e,n-=t,o-=e,r-=t,0!==(u=(l-=a=(a+g)*w)*(E-=s=(s+S)*H)-(p-=a)*(c-=s))&&(y=e-(h=(E*i-c*o)*(T=1/u))*a-(v=(l*o-p*i)*T)*s,R=t-(m=(E*n-c*r)*T)*a-(x=(l*r-p*n)*T)*s,V.save(),V.transform(h,m,v,x,y,R),V.fill(),V.restore())}function Ee(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!==a&&(o*=n=i/Math.sqrt(a),r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function fe(e){j!==e&&(V.globalAlpha=e,j=e)}function de(e){k!==e&&(e===THREE.NormalBlending?V.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?V.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending?V.globalCompositeOperation="darker":e===THREE.MultiplyBlending&&(V.globalCompositeOperation="multiply"),k=e)}function he(e){N!==e&&(V.lineWidth=e,N=e)}function me(e){O!==e&&(V.lineCap=e,O=e)}function ve(e){A!==e&&(V.lineJoin=e,A=e)}function xe(e){D!==e&&(V.strokeStyle=e,D=e)}function ye(e){F!==e&&(V.fillStyle=e,F=e)}function Re(e){I.length!==e.length&&(V.setLineDash(e),I=e)}void 0===V.setLineDash&&(V.setLineDash=function(){}),this.domElement=g,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return V},this.getContextAttributes=function(){return V.getContextAttributes()},this.getPixelRatio=function(){return P},this.setPixelRatio=function(e){void 0!==e&&(P=e)},this.setSize=function(e,t,i){S=e*P,w=t*P,g.width=S,g.height=w,H=Math.floor(S/2),C=Math.floor(w/2),!1!==i&&(g.style.width=e+"px",g.style.height=t+"px"),Q.min.set(-H,-C),Q.max.set(H,C),X.min.set(-H,-C),X.max.set(H,C),j=1,k=0,D=null,F=null,N=null,O=null,A=null,this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){M=e*P,b=t*P,L=i*P,B=n*P},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(e,t){W.set(e),z=void 0!==t?t:1,X.min.set(-H,-C),X.max.set(H,C)},this.setClearColorHex=function(e,t){console.warn("THREE.CanvasRenderer: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getClearColor=function(){return W},this.getClearAlpha=function(){return z},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===X.isEmpty()&&(X.intersect(Q),X.expandByScalar(2),X.min.x=X.min.x+H,X.min.y=-X.min.y+C,X.max.x=X.max.x+H,X.max.y=-X.max.y+C,z<1&&V.clearRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0),z>0&&(de(THREE.NormalBlending),fe(1),ye("rgba("+Math.floor(255*W.r)+","+Math.floor(255*W.g)+","+Math.floor(255*W.b)+","+z+")"),V.fillRect(0|X.min.x,0|X.max.y,X.max.x-X.min.x|0,X.min.y-X.max.y|0)),X.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,s){if(s instanceof THREE.Camera!=!1){var l=e.background;l&&l.isColor?(ye("rgb("+Math.floor(255*l.r)+","+Math.floor(255*l.g)+","+Math.floor(255*l.b)+")"),V.fillRect(0,0,S,w)):!0===this.autoClear&&this.clear(),u.info.render.vertices=0,u.info.render.faces=0,V.setTransform(L/S,0,0,-B/w,M,w-b),V.translate(H,C),t=T.projectScene(e,s,this.sortObjects,this.sortElements),i=t.elements,n=t.lights,s,ne.getNormalMatrix(s.matrixWorldInverse),function(){Z.setRGB(0,0,0),$.setRGB(0,0,0),_.setRGB(0,0,0);for(var e=0,t=n.length;e<t;e++){var i=n[e],o=i.color;i instanceof THREE.AmbientLight?Z.add(o):i instanceof THREE.DirectionalLight?$.add(o):i instanceof THREE.PointLight&&_.add(o)}}();for(var c=0,p=i.length;c<p;c++){var E=i[c],f=E.material;if(void 0!==f&&0!==f.opacity){if(Y.makeEmpty(),E instanceof THREE.RenderableSprite)(o=E).x*=H,o.y*=C,oe(o,E,f);else if(E instanceof THREE.RenderableLine)o=E.v1,r=E.v2,o.positionScreen.x*=H,o.positionScreen.y*=C,r.positionScreen.x*=H,r.positionScreen.y*=C,Y.setFromPoints([o.positionScreen,r.positionScreen]),!0===Q.intersectsBox(Y)&&re(o,r,E,f);else if(E instanceof THREE.RenderableFace){if(o=E.v1,r=E.v2,a=E.v3,o.positionScreen.z<-1||o.positionScreen.z>1)continue;if(r.positionScreen.z<-1||r.positionScreen.z>1)continue;if(a.positionScreen.z<-1||a.positionScreen.z>1)continue;o.positionScreen.x*=H,o.positionScreen.y*=C,r.positionScreen.x*=H,r.positionScreen.y*=C,a.positionScreen.x*=H,a.positionScreen.y*=C,f.overdraw>0&&(Ee(o.positionScreen,r.positionScreen,f.overdraw),Ee(r.positionScreen,a.positionScreen,f.overdraw),Ee(a.positionScreen,o.positionScreen,f.overdraw)),Y.setFromPoints([o.positionScreen,r.positionScreen,a.positionScreen]),!0===Q.intersectsBox(Y)&&ae(o,r,a,0,1,2,E,f)}X.union(Y)}}V.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}};