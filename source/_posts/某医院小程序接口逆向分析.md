---
title: æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ
author: Qi Zhao
comments: true
tags:
  - é€†å‘åˆ†æ
  - å°ç¨‹åº
  - Proxifier
  - Burp Suite
abbrlink: 3592944982
date: 2025-01-27 16:31:41
categories:
  - é€†å‘åˆ†æ
---

## æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ
æœ€è¿‘ä½¿ç”¨æŸåŒ»é™¢å°ç¨‹åºæ—¶ï¼Œå‘ç°åªèƒ½æŸ¥è¯¢æœ€è¿‘åŠå¹´çš„æ£€æŸ¥æŠ¥å‘Šã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰å¯èƒ½é€šè¿‡ä¿®æ”¹è¯·æ±‚å‚æ•°ï¼Œè·å–åˆ°æ›´æ—©æ—¶é—´çš„æ£€æŸ¥æŠ¥å‘Šå‘¢ï¼Ÿ

<!-- more -->

## ç¯å¢ƒ&å·¥å…·
* [WeChat 3.8.9](https://weixin.qq.com/)
* [Proxifier](https://www.proxifier.com/download/)
* [Brup Suite](https://portswigger.net/burp/communitydownload)
* `pip install pycryptodome`
* [Node.js](https://nodejs.org/en/download/)
```shell
~$ node -v
v18.17.0
~$ npm -v
10.9.1
```

## é…ç½®Brup Suite
1. Proxy -> Proxy Settings -> Import/export CA certificate -> Certificate in DER format,é€‰æ‹©CAæ–‡ä»¶çš„è·¯å¾„å¹¶å‘½åä¸º`xxx.crt`
![export CA](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/brupsuite_ca_1.jpg)
2. åŒå‡»ç”Ÿæˆçš„CAæ–‡ä»¶ï¼Œå¯¼å…¥é’¥åŒ™ä¸²
3. åŒå‡»`PortSwiger CA`,ä¿¡ä»»è®¾ç½®ä¸º"å§‹ç»ˆä¿¡ä»»"
![PortSwiger CA](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/brupsuite_ca_2.jpg)

## é…ç½®Proxifier

1. é…ç½®Proxy: ä¾æ¬¡ç‚¹å‡»`Rules` -> `Add`,åœ°å€ä¸º`127.0.0.1`,ç«¯å£ä¸º`Brup Suite`å¯¹åº”çš„ç«¯å£
![Proxifier](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/proxifier_1.jpg)
1. é…ç½®Rule: ä¾æ¬¡ç‚¹å‡»`Rules` -> `Add`-> `+`,é€‰æ‹©`WeChatAppEx Helper.app`
    > å¿«æ·é”®command+shift+Gæœç´¢`/Applications/WeChat.app/Contents/MacOS/WeChatAppEx.app/Contents/Frameworks/WeChatAppEx Framework.framework/`,ç‚¹å‡»`Helpers`

    ![Proxifier Rule](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/proxifier_2.jpg)
    ![Proxifier Rule](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/proxifier_3.jpg)
3. æ‰“å¼€Brup Suiteå’ŒWeChatå°ç¨‹åº,æ­¤æ—¶å·²ç»å¯ä»¥çœ‹åˆ°å°ç¨‹åºå‘å‡ºçš„ç½‘ç»œè¯·æ±‚

## å°ç¨‹åºåç¼–è¯‘
1. è¿›å…¥ç›®å½•`~/Library/Containers/com.tencent.xinWeChat/Data/.wxapplet/packages/`,ä¼šçœ‹åˆ°ä¸€å †å‘½åä¸ºwxå¼€å¤´çš„`{AppID}`çš„æ–‡ä»¶å¤¹,æ‰¾åˆ°å¯¹åº”ğŸ¥å°ç¨‹åºæ‰€åœ¨çš„ç›®å½•
   * å¯åˆ é™¤æ‰€æœ‰wxå¼€å¤´çš„`{AppID}`æ–‡ä»¶å¤¹åï¼Œé‡æ–°æ‰“å¼€ğŸ¥å°ç¨‹åº
   * ä¹Ÿå¯åœ¨ç§»åŠ¨ç«¯`Wechat`->å¼€å‘è€…èµ„æ–™->`AppID`ä¸­ç›´æ¥è·å–AppID
2. è¿›å…¥`{AppID}`æ‰€åœ¨ç›®å½•ï¼Œæ‰¾åˆ°åä¸º`__APP__.wxapkg`çš„æ–‡ä»¶
3. å‡†å¤‡`wxappUnpacker`ç¯å¢ƒ
    ```shell
    git clone https://gitee.com/ksd/wxappUnpacker.git
    cd wxappUnpacker
    npm install
    npm install esprima
    npm install css-tree
    npm install cssbeautify
    npm install vm2
    npm install uglify-es
    npm install js-beautify
    ```
4. æ‰§è¡Œåç¼–è¯‘,å¾—åˆ°å°ç¨‹åºæºç ,å¯èƒ½ä¼šå‡ºç°`TypeError: subPackage.pages is not iterabl`çš„æŠ¥é”™ï¼Œå¿½ç•¥å³å¯
    ```shell
    ~$ ./bingo.sh ../__APP__.wxapkg
    ```
## ä»£ç å®¡è®¡
1. æ¯”è¾ƒç›¸é‚»2æ¬¡è¯·æ±‚,å‘ç°é™¤è¯·æ±‚å‚æ•°å¤–,åªæœ‰`X-Api-Key`å’Œ`Request-No`ä¸åŒ
![Compare](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/brupsuite_cmp.jpg)
2. `Request-No`ç›²çŒœæ˜¯è¯·æ±‚åºå·,ç›´æ¥åœ¨`app-server.js`ä¸­æœç´¢`X-Api-Key`
![X-Api-Key](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/app-service_1.jpg)
3. æ‰¾åˆ°`a`å¯¹åº”çš„`n(465)`å‡½æ•°,å‘ç°æœ€ç»ˆè°ƒç”¨äº†`i.encrypt`æ–¹æ³•,`p`åº”è¯¥æ˜¯ç”¨æ¥è®¡ç®—`hashDigest`
![n(465)](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/app-service_2.jpg)
4. åˆ†æ`p(e, t)`å‡½æ•°,`f`æ•°ç»„ç”±ä»¥ä¸‹å‡ éƒ¨åˆ†ç»„æˆ:
* pathname + query
* `i.REQUEST_HASH_HEADERS`ä¸­çš„headeræŒ‰ç…§`{key}={value}`çš„æ ¼å¼ç”¨`,`è¿æ¥
* `PUT`å’Œ`POST`è¯·æ±‚çš„body`JSON.stringify`åçš„å­—ç¬¦ä¸²
  
    è¿‡æ»¤æ‰æ•°ç»„ä¸­çš„ç©ºå­—ç¬¦ä¸²ï¼Œç”¨`&&`è¿æ¥å‰©ä½™éƒ¨åˆ†ï¼Œç„¶åè®¡ç®—MD5å€¼
![p(e,t)](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/app-service_3.jpg)
5. æ‰¾åˆ°`i`å¯¹åº”çš„`n(392)`å‡½æ•°,å‘ç°è¢«æ··æ·†äº†;
![n(392)](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/app-service_4.jpg)
å°†`n(392)`å‡½æ•°çš„ä»£ç æ‹·è´è‡³`n392.js`ï¼Œæ¨¡æ‹Ÿæ··æ·†è¿‡ç¨‹ï¼Œç”¨æ­£åˆ™æ‰¹é‡æ›¿æ¢å¾—åˆ°åæ··æ·†åçš„`n391_decrypt.js`
    ```javascript
    var n = i => {
    return e[i - 224];
    };
    var r = e;

    for (let index = 0; index < e.length; index++) {
    try {
        if (
        773152 == -parseInt(n(243)) / 1 +
            (parseInt(n(254)) / 2) * (-parseInt(n(250)) / 3) +
            (-parseInt(n(226)) / 4) * (-parseInt(n(237)) / 5) +
            parseInt(n(252)) / 6 + parseInt(n(231)) / 7 +
            (-parseInt(n(227)) / 8) * (-parseInt(n(248)) / 9) +
            (parseInt(n(235)) / 10) * (-parseInt(n(258)) / 11)
        )
        break;
        r.push(r.shift());
    } catch (e) {
        r.push(r.shift());
    }
    }

    const fs = require('fs');

    let data = fs.readFileSync('n392.js', 'utf8');

    for (let [index, item] of e.entries()) {
    data = data.replace(new RegExp(`r\\(${224 + index}\\)|a\\(${224 + index}\\)`, 'g'), `"${item}"`);
    }

    console.log(data);
    fs.writeFileSync('n392_decrypted.js', data);
    ```

6. åˆ†æåæ··æ·†åçš„`n392_decrypt.js`,å¾—åˆ°AESåŠ å¯†ç”¨çš„`KEY`å’Œ`IV`ã€è®¡ç®—MD5ç”¨çš„`REQUEST_HASH_HEADERS`
![n392 decrypt](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/app-service_5.jpg)

* DEFAULT_ENCRYPT_KEY = "o(sogq[@AN,p,,6U_IpEyPD9-Sz,]=5v"
* DEFAULT_ENCRYPT_IV = "csJD=|<svU)?Hmq1"
* REQUEST_HASH_HEADERS = ["X-User-Id", "X-Hos-Id", "X-Auth-Token', "X-Api-Ver"]

    å°è¯•è§£å¯†ä¸€ä¸ª`X-Api-Key`çš„å€¼,å¾—åˆ°è¢«AESåŠ å¯†å‰çš„æ•°æ®
    ```python
    from Crypto.Cipher import AES
    from base64 import b64decode, b64encode
    from Crypto.Util.Padding import pad, unpad

    DEFAULT_ENCRYPT_KEY = b"o(sogq[@AN,p,,6U_IpEyPD9-Sz,]=5v"
    DEFAULT_ENCRYPT_IV = b"csJD=|<svU)?Hmq1"

    encrypted_b64 = "<X-Api-Key>"

    cipher = AES.new(DEFAULT_ENCRYPT_KEY, AES.MODE_CBC, iv=DEFAULT_ENCRYPT_IV)
    decrypted = unpad(cipher.decrypt(b64decode(encrypted_b64)), AES.block_size).decode("utf-8")
    ```
    `json.loads(decrypted)`åçš„æ•°æ®:
    ```json
    {
        "accessEntry": "local-patient-miniapp",
        "timestamp": 1735565655493,
        "replayNo": "4a43104a-5b76-4e21-9e7f-dee01c45b648",
        "hashDigest": "91e260d5bf94fc1eed38769b6cc71cd6",
    }
    ```
7. ç»¼ä¸Šï¼Œå¦‚æœæƒ³è¦è·å–å…¶ä»–æ—¶é—´èŒƒå›´çš„æ£€æŸ¥æŠ¥å‘Šï¼Œåªéœ€ä¿®æ”¹æŸ¥è¯¢å‚æ•°åï¼ŒæŒ‰ç…§æ–°çš„æŸ¥è¯¢å‚æ•°é‡æ–°è®¡ç®—MD5å€¼ï¼Œæ›¿æ¢è¢«ç­¾åçš„åŸå§‹æ•°æ®ä¸­çš„`hashDigest`åï¼Œé‡æ–°AESåŠ å¯†è®¡ç®—æ–°çš„`<X-Api-Key>`å³å¯
    ```python
    data["hashDigest"] = "<NEW MD5>"
    plain = json.dumps(data, separators=(",", ":"), ensure_ascii=False)
    encrypted = cipher.encrypt(pad(plain.encode("utf-8"), AES.block_size))
    encrypted_b64 = b64encode(encrypted).decode("utf-8")
    ```
8. å‚ç…§`p(e, t)`å’Œ`REQUEST_HASH_HEADERS`è®¡ç®—MD5å€¼
    ```python
    import hashlib

    def calculate_md5(input_string):
        md5_hash = hashlib.md5()
        md5_hash.update(input_string.encode("utf-8"))
        return md5_hash.hexdigest()

    headers = {
        "X-User-Id": 12345678,
        "X-Hos-Id": 12345678,
        "X-Auth-Token": '<X-Auth-Token>',
        "X-Api-Ver": "2.26.7",
    }

    lst = list()
    lst.append(
        "/patient/v1/report/record?inspectType=UC&reportType=3&cardNos=xxxxx&startTime=2024-12-24&endTime=2024-12-31"
    )
    lst.append(",".join([f"{k.lower()}={v}" for k, v in headers.items()]))
    string_to_sign = "&&".join(lst)
    md5 = calculate_md5(string_to_sign)
    ```

## ä¿®æ”¹è¯·æ±‚
1. æ‰“å¼€`BrupSuite`çš„`Proxy Intercept`å¼€å…³ï¼Œä»¥æ‹¦æˆªå°ç¨‹åºçš„è¯·æ±‚
2. æ‰“å¼€ğŸ¥å°ç¨‹åºï¼Œç‚¹å‡»"æŸ¥æŠ¥å‘Š"
![æŸ¥è¯¢æŠ¥å‘Š](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/wechat_1.jpg)
3. ä»`Brup Suite`ä¸­å¤åˆ¶`Path+Query`ã€`REQUEST_HASH_HEADERS`ã€`<X-Auth-Token>`å’Œ`<X-Api-Key>`å¯¹åº”çš„å€¼
4. æ‰§è¡ŒPythonè„šæœ¬è®¡ç®—æ–°çš„`<X-Api-Key>`ï¼Œç„¶åæ›´æ–°`Brup Suite`ä¸­çš„è¯·æ±‚å‚æ•°å’Œ`X-Api-Key`ï¼Œç‚¹å‡»`Forward`
![Brup Suite forward](æŸåŒ»é™¢å°ç¨‹åºæ¥å£é€†å‘åˆ†æ/brupsuite_forward.jpg)

## å‚è€ƒ
* [macä¸‹chromeå¯¼å…¥burpè¯ä¹¦ - CSDN](https://www.cnblogs.com/Hi-blog/p/How-To-Import-BurpSuite-Certificate-To-Chrome-On-MacOS.html)
* [Mac m2ä½¿ç”¨å®ç°å¾®ä¿¡å°ç¨‹åºæŠ“åŒ… - åšå®¢å›­](https://www.cnblogs.com/mr-ryan/p/17680899.html)
* [ä½¿ç”¨wxappUnpackerå·¥å…·è¿›è¡ŒMACå¾®ä¿¡å°ç¨‹åºåç¼–è¯‘ - æ˜é‡‘](https://juejin.cn/post/7360996405581381667)

## å®Œæ•´ä»£ç 
```python
import hashlib
import json
from base64 import b64decode, b64encode

from Crypto.Cipher import AES
from Crypto.Util.Padding import pad, unpad


def calculate_md5(input_string):
    md5_hash = hashlib.md5()
    md5_hash.update(input_string.encode("utf-8"))
    return md5_hash.hexdigest()


DEFAULT_ENCRYPT_KEY = b"o(sogq[@AN,p,,6U_IpEyPD9-Sz,]=5v"  # 32 å­—èŠ‚å¯†é’¥
DEFAULT_ENCRYPT_IV = b"csJD=|<svU)?Hmq1"  # 16 å­—èŠ‚åˆå§‹åŒ–å‘é‡


token = "<X-Auth-Token>"
x_user_id = "<X-User-Id>"
x_hos_id = "<X-Hos-Id>"

headers = {
    "X-User-Id": x_user_id,
    "X-Hos-Id": x_hos_id,
    "X-Auth-Token": token,
    "X-Api-Ver": "2.26.7",
}
encrypted_b64 = "<X-Api-Key>"

lst = list()
lst.append(
    "/patient/v1/report/record?inspectType=UL&reportType=3&cardNos=xxxxxx&startTime=2024-01-01&endTime=2024-12-31"
)  # æ£€éªŒ
lst.append(",".join([f"{k.lower()}={v}" for k, v in headers.items()]))
string_to_sign = "&&".join(lst)
md5 = calculate_md5(string_to_sign)
print("MD5", md5)

cipher = AES.new(DEFAULT_ENCRYPT_KEY, AES.MODE_CBC, iv=DEFAULT_ENCRYPT_IV)
decrypted = unpad(cipher.decrypt(b64decode(encrypted_b64)), AES.block_size).decode("utf-8")
print("decrypted", decrypted)

data = json.loads(decrypted)
data["hashDigest"] = md5

# Encrypt
cipher = AES.new(DEFAULT_ENCRYPT_KEY, AES.MODE_CBC, iv=DEFAULT_ENCRYPT_IV)
plain = json.dumps(data, separators=(",", ":"), ensure_ascii=False)
encrypted = cipher.encrypt(pad(plain.encode("utf-8"), AES.block_size))
encrypted_b64 = b64encode(encrypted).decode("utf-8")
print("encrypted_b64", encrypted_b64)
```